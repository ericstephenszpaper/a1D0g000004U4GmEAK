<!--
// Name: Index Page
// Committer: marty.harvey@zpaper.com
// Update: MSH181008 since we changed the doc context, change it back
-->
<script>
//--- RULE JSON REPRESENTATION ---
var ruleJson = {"type":"rool","updated":"2018-10-08 20:18:25","active":true,"button":"Save","name":"Index Page","conditions":{"logic":"and","arguments":[{"name":"doc.X(\"X_buttonAction\")","value":"Save","operation":"equals"}]},"consequence":{"doit":"LyogQkVHSU4gSW5kZXggUGFnZSAqLwphbGVydCgiQEBAQCBJbmRleCBSdWxlIEZpcmVkIEBAQCMiKTsKLy9NU0gxODA5MjQgIzUyNDQwIHBvcHVsYXRlIGdyb3VwSUQsIGltYWdlSWRzLCBhbmQgek5hdGl2ZUZpbGVOYW1lIG9uIGNoaWxkIHN0YWNrCmZ1bmN0aW9uIGZpbmRNYXRjaGluZ0ltYWdlSWRzKGFQYWdlUmFuZ2UsIHBhcmVudEltYWdlSWRzQXJyKSB7CiAgICB2YXIgcnRuID0gIiI7CiAgICB2YXIgcGFnZVJhbmdlID0gYVBhZ2VSYW5nZTsKICAgIHZhciBwYWdlcyA9IHBhZ2VSYW5nZS5zcGxpdCgiLCIpOwogICAgaWYgKHBhZ2VzLmxlbmd0aCA+IDEpIHsKICAgICAgICBhbGVydCgicGFnZXMubGVuZ3RoID4gMSIpOwogICAgICAgIGZvciAodmFyIG0gPSAwOyBtIDwgcGFnZXMubGVuZ3RoOyBtKyspIHsKICAgICAgICAgICAgaWYgKDAgPT09IHJ0bi5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHJ0biA9IHBhcmVudEltYWdlSWRzQXJyW3BhZ2VzW21dIC0gMV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBydG4gKz0gIiwiICsgcGFyZW50SW1hZ2VJZHNBcnJbcGFnZXNbbV0gLSAxXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgcnRuID0gcGFyZW50SW1hZ2VJZHNBcnJbcGFnZXNbMF0gLSAxXTsKICAgIH0KICAgIHJldHVybiBydG47Cn0KCi8vTVNIMTgwOTI1ICM1MjQ0MCBtb3ZlZCBoZXJlIGZyb20gYmVsb3cgc28gaXQncyBhdmFpbGFibGUKdmFyIHBhZ2VSYW5nZSA9IFgoZG9jLCAiWF9pZHhQYWdlcyIpOwp2YXIgZ3JvdXBJRCA9IFgoZG9jLCAiR3JvdXBJRCIpOwp2YXIgaW1hZ2VJRHMgPSBYKGRvYywgIkltYWdlSURzIik7CgphbGVydCgiIyMjIyBmdWxsIGxpc3Qgb2YgSW1hZ2VJRHMgZnJvbSBwYXJlbnQgc3RhY2s6ICIgKyBpbWFnZUlEcyk7CnZhciBuYXRpdmVGaWxlTmFtZSA9IFgoZG9jLCAiek5hdGl2ZUZpbGVOYW1lIik7CnZhciBpbWFnZXNGb3JUaGlzU3RhY2sgPSBudWxsOwppZiAoaW1hZ2VJRHMpIHsKICAgIHZhciBpbWFnZUlkc0FyciA9IGltYWdlSURzLnNwbGl0KCIsIik7CiAgICBhbGVydCgiIyMjIHBhcmVudCBpbWFnZXMgYXJyYXkgPSAiICsgaW1hZ2VJZHNBcnIpOwogICAgaW1hZ2VzRm9yVGhpc1N0YWNrID0gZmluZE1hdGNoaW5nSW1hZ2VJZHMocGFnZVJhbmdlLCBpbWFnZUlkc0Fycik7Cn0KLy9NU0gxODEwMDMga2VlcCB0aGUgYXJyYXkgZm9ybWF0IGNvcnJlY3QKaWYgKCFpbWFnZXNGb3JUaGlzU3RhY2spIHsKICAgIGltYWdlc0ZvclRoaXNTdGFjayA9ICIiOwp9CmFsZXJ0KCIjIyMjIGltYWdlcyBmb3IgdGhpcyBzdGFjayA9ICIgKyBpbWFnZXNGb3JUaGlzU3RhY2spOwovL01TSDE4MDkyNCAjNTI0NDAgRU5ECgpmdW5jdGlvbiBzZXREb2NTZXRTdGF0dXMoYURvYywgYW5BcnJPZlBhaXJzKSB7CiAgICB2YXIgYmEgPSBYKGFEb2MsICJYX2J1dHRvbkFjdGlvbiIpICsgImVkIjsKICAgIGJhID0gYmEuc3Vic3RyaW5nKDEgKyBiYS5sYXN0SW5kZXhPZigiICIpKTsKICAgIHZhciBub3cwID0gZ2V0Q3VyRGF0ZUFuZFRpbWUoYURvYywgZmFsc2UsIHRydWUpOwogICAgYW5BcnJPZlBhaXJzLnB1c2goIlhfcmV2aWV3ZWRTdGF0dXMiLCBiYSk7CiAgICBhbkFyck9mUGFpcnMucHVzaCgiWF9yZXZpZXdzIiwgWChhRG9jLCAiWF9yZXZpZXdzIikgKyBiYSArICIgYnkgIiArIGFEb2Mua2JEYXRhLnJlbW90ZVVzZXIgKyAiIGF0ICIgKyBub3cwICsgIjxici8+Iik7IC8vRVJTMTcwOTA5ICM0MDU5MgogICAgYW5BcnJPZlBhaXJzLnB1c2goIlhfYnV0dG9uQWN0aW9uIiwgIiIpOwp9Ci8qIGRvdWJsZS1xdW90ZSwgbmV3bGluZSBjaGFyYWN0ZXJzICovCnZhciBkcSA9IFN0cmluZy5mcm9tQ2hhckNvZGUoMzQpOwovL01TSDE4MDkyNCB1bnVzZWQgdmFyIG5sID0gU3RyaW5nLmZyb21DaGFyQ29kZSgxMCk7CnZhciBmb3JtYXROb3cgPSBnZXRDdXJEYXRlQW5kVGltZShkb2MpOwp2YXIgc3RhY2tJZCA9IFgoZG9jLCAiWF9zdGFjayIpOwp2YXIgc3RhY2tGb2xkZXIgPSBzdGFja0lkICsgIi1TVEFDSyI7CnZhciBjb21wYW55Q29kZSA9IGRvYy5kZWxpdmVyZWRUbzsKdmFyIHRpZmZTZklkID0gIiI7CnZhciBwYXJlbnRGb2xkZXIgPSBYKGRvYywgIlhfY3VyRm9sZGVyIik7CnZhciBwYXJlbnRkYklEID0gZG9jLmRiSUQ7IC8vSlBCMTgwNjA2IGFkZGVkIGRvYy5kYklECgovKiBDbGVhciB0aGUgdHJpZ2dlciB0aGF0IGludm9rZWQgdGhpcyBydWxlICovCi8vRVJTMTcwOTA5IHpEYXRhLmNsZWFyVHJpZ2dlckNvbmRpdGlvbihkb2MsIlhfYnV0dG9uQWN0aW9uIik7CnZhciBpbmRleEluaXRpYWxpemVkID0gWChkb2MsICJYX2luZGV4SW5pdGlhbGl6ZWQiKTsKaWYgKCFpbmRleEluaXRpYWxpemVkIHx8IDAgPT09IGluZGV4SW5pdGlhbGl6ZWQubGVuZ3RoKSB7CiAgICBzdGFja0lkID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgKyAiIjsKICAgIHN0YWNrRm9sZGVyID0gc3RhY2tJZCArICItU1RBQ0siOwogICAgekRhdGEuaW5pdGlhbGl6ZVN0YWNrKGRvYywgc3RhY2tGb2xkZXIsIGNvbXBhbnlDb2RlLCBzdGFja0lkKTsKfQoKLy8gRG9lcyB0aGUgdXNlciB3YW50IHRvIGF0dGFjaCBpbmRleGVkIHBhZ2VzIHRvIENhc2U/Ci8vdmFyIHNmU3RhY2tJZCA9IFgoZG9jLCAiWF9zZlN0YWNrSWQiKTsKdmFyIHBhcmVudFNmU3RhY2tJZCA9IFgoZG9jLCAiWF9zZlN0YWNrSWQiKTsKdmFyIGNhc2VJZCA9IFgoZG9jLCAiWF9aUEFQRVJfX0Nhc2VfX2MiKTsKdmFyIGNvbnRhY3RJZCA9IFgoZG9jLCAiWF9aUEFQRVJfX1BhdGllbnRfX2MiKTsKLy9NU0gxODA5MjQgdW51c2VkIHZhciBwYXRpZW50SWQgPSBjb250YWN0SWQ7IC8vVE9ETwp2YXIgcHJvdmlkZXJJZCA9IFgoZG9jLCAiWF9aUEFQRVJfX1Byb3ZpZGVyX19jIik7CnZhciBwYXRpZW50Rmlyc3ROYW1lID0gWChkb2MsICJYX1pQQVBFUl9fRmlyc3ROYW1lX19jIik7CnZhciBwYXRpZW50TGFzdE5hbWUgPSBYKGRvYywgIlhfWlBBUEVSX19MYXN0TmFtZV9fYyIpOwp2YXIgcGF0aWVudERPQiA9IFgoZG9jLCAiWF9aUEFQRVJfX0JpcnRoZGF0ZV9fYyIpOwp2YXIgcGF0aWVudE5hbWUgPSBYKGRvYywgIlhfWlBBUEVSX19QYXRpZW50X19yLk5hbWUiKTsKdmFyIGRvY1R5cGUgPSBYKGRvYywgIlhfWlBBUEVSX19mYXhUeXBlX19jIik7Ci8vTVNIMTgxMDA0IHZhciB6VHlwZSA9IGRvYy5YKCJYX2RvY1R5cGUiKTsKdmFyIHpUeXBlID0gWChkb2MsICJYX2RvY1R5cGUiKTsKLy9NU0gxODA5MjQgdW51c2VkIHZhciBub3dEYXRlID0gZ2V0Q3VyRGF0ZShkb2MpOwp2YXIgY2FzZVJlY29yZFR5cGUgPSBYKGRvYywgIlhfQ2FzZV9SZWNvcmRfVHlwZV9fYyIpOwovL01TSDE4MDkyNCB1bnVzZWQgdmFyIGRvY1R5cGVMYWJlbCA9IFgoZG9jLCAiWF9aUEFQRVJfX2ZheFR5cGVMYWJlbCIpOwp2YXIgdXNlckNsYXNzaWZpY2F0aW9uID0gWChkb2MsICJYX1pQQVBFUl9fQ2xhc3NpZmljYXRpb25fX2MiKTsKCi8vTVNIMTgwOTI0IGxldCdzIGNoZWNrIHRoZSB2YWx1ZSBiZWZvcmUgd2UgdHJ5IHRvIHVzZSBpdDsgbW92ZWQgaGVyZSBmcm9tIGJlbG93CmlmIChwYXJlbnRTZlN0YWNrSWQgPT09ICIiKSB7IC8vRVJTMTcwNzMxICM0MDU5MwogICAgYWxlcnQoIkBAQEBAQCBwYXJlbnRTZlN0YWNrSWQgaXMgZW1wdHkuIEF0dGVtcHRpbmcgWF9hdHRhY2hlZFRvIik7CiAgICAvL01TSDE4MDkyNCBkb2VzIG5vdGhpbmc7IHBlcmhhcHMgdGhpcz8gWChkb2MsICJYX2F0dGFjaGVkVG8iKTsKICAgIHBhcmVudFNmU3RhY2tJZCA9IFgoZG9jLCAiWF9hdHRhY2hlZFRvIik7CiAgICBpZiAocGFyZW50U2ZTdGFja0lkLmxhc3RJbmRleE9mKCIvIikgPj0gMCkgewogICAgICAgIHBhcmVudFNmU3RhY2tJZCA9IHBhcmVudFNmU3RhY2tJZC5zdWJzdHJpbmcocGFyZW50U2ZTdGFja0lkLmxhc3RJbmRleE9mKCIvIikgKyAxKTsKICAgICAgICBpZiAocGFyZW50U2ZTdGFja0lkLmluZGV4T2YoIiwiKSA+PSAwKSB7CiAgICAgICAgICAgIHBhcmVudFNmU3RhY2tJZCA9IHBhcmVudFNmU3RhY2tJZC5zdWJzdHJpbmcoMCwgcGFyZW50U2ZTdGFja0lkLmluZGV4T2YoIiwiKSk7CiAgICAgICAgfQogICAgfQp9CmFsZXJ0KCJAQEBAQEAgcGFyZW50U2ZTdGFja0lkID0gIiArIHBhcmVudFNmU3RhY2tJZCk7Ci8vYWxlcnQoIkBAQEAgcGFyZW50IHN0YWNrIGlkID0gIiArIHNmU3RhY2tJZCk7CnZhciBwYXJlbnRTdGFja051bWJlciA9IGdldFNGRmllbGQoZG9jLCAiWlBBUEVSX196U3RhY2tfX2MiLCAiTmFtZSIsIG51bGwsIHBhcmVudFNmU3RhY2tJZCk7CmFsZXJ0KCIjIyMjIE91ciBwYXJlbnQgc3RhY2sgbnVtYmVyIGlzICIgKyBwYXJlbnRTdGFja051bWJlcik7CnZhciB6UGFyZW50UmVjb3JkID0gZ2V0U0ZGaWVsZHMoZG9jLCAiWlBBUEVSX196U3RhY2tfX2MiLCAiTmFtZSxaUEFQRVJfX2xhdGVzdEZheF9fYyxaUEFQRVJfX0NsYXNzaWZpY2F0aW9uX19jLFpQQVBFUl9fUHJpb3JpdHlfX2MiLCBudWxsLCBwYXJlbnRTZlN0YWNrSWQpOwovL01TSDE4MDkyNCB1bnVzZWQgdmFyIHpTdGFja0NsYXNzaWZpY2F0aW9uID0gWChkb2MsICJaUEFQRVJfX0NsYXNzaWZpY2F0aW9uX19jIiwgelBhcmVudFJlY29yZCk7CmFsZXJ0KCJAQEBAQEAgelBhcmVudFJlY29yZCAgIiArIHpQYXJlbnRSZWNvcmQpOwoKdmFyIHNmVXNlcklkID0gZ2V0U0ZSZWNvcmRJRChkb2MsICJVc2VyIiwgeyJVc2VybmFtZSI6IGRvYy5zZlVzZXJOYW1lfSk7CgovL3ZhciB6U3RhY2tOYW1lID0gWChkb2MsICJOYW1lIiwgelBhcmVudFJlY29yZCk7CnZhciByZWNlaXZlZEF0ID0gWChkb2MsICJaUEFQRVJfX2xhdGVzdEZheF9fYyIsIHpQYXJlbnRSZWNvcmQpOwoKLy8gR2V0IHRoZSBkb2N1bWVudCB0eXBlICh3aWxsIGJlIHVzZWQgdG8gcm91dGUgdG8gbmV4dCBmb2xkZXIpCnZhciBuZXh0Rm9sZGVyID0gIjIwNTAwVHJpYWdlLVMyIjsgLy8gT3RoZXIgZm9sZGVyIGlzIHRoZSBkZWZhdWx0CnZhciBwcmV2SW5kZXhQYWdlcyA9IFgoZG9jLCAiWF9pbmRleGVkUGFnZXMiKTsKdmFyIGN1ckluZGV4UGFnZXMgPSBYKGRvYywgIlhfaWR4UGFnZXMiKTsKaWYgKHByZXZJbmRleFBhZ2VzICYmIHByZXZJbmRleFBhZ2VzLmxlbmd0aCA+IDAgJiYgY3VySW5kZXhQYWdlcyAmJiBjdXJJbmRleFBhZ2VzLmxlbmd0aCA+IDApIHsKICAgIHByZXZJbmRleFBhZ2VzICs9ICIsIjsKfQpjdXJJbmRleFBhZ2VzID0gcHJldkluZGV4UGFnZXMgKyBjdXJJbmRleFBhZ2VzOwp2YXIgYXJyT2ZQYWlycyA9IFtdOwphcnJPZlBhaXJzLnB1c2goIlhfaW5kZXhlZFBhZ2VzIiwgY3VySW5kZXhQYWdlcyk7CmlmICgxID09PSAxKSB7IC8vRVJTMTcwOTA5ICM0MDU5MiBmb3IgekRvY1NldCBzdGF0dXNlcwogICAgLy9NU0gxODA5MjQgdXNlIFgoZG9jLCAibm5ubm5ubiIpIGluc3RlYWQgdmFyIGJhID0gZG9jLlgoIlhfYnV0dG9uQWN0aW9uIikrImVkIjsKICAgIC8qIE1TSDE4MDkyNCBtb3ZlZCB0byBmdW5jdGlvbiBhYm92ZQogICAgIHZhciBiYSA9IFgoZG9jLCAiWF9idXR0b25BY3Rpb24iKSArICJlZCI7CiAgICAgYmEgPSBiYS5zdWJzdHJpbmcoMSArIGJhLmxhc3RJbmRleE9mKCIgIikpOwogICAgIHZhciBub3cwID0gZ2V0Q3VyRGF0ZUFuZFRpbWUoZG9jLCBmYWxzZSwgdHJ1ZSk7CiAgICAgYXJyT2ZQYWlycy5wdXNoKCJYX3Jldmlld2VkU3RhdHVzIiwgYmEpOwogICAgIGFyck9mUGFpcnMucHVzaCgiWF9yZXZpZXdzIiwgWChkb2MsICJYX3Jldmlld3MiKSArIGJhICsgIiBieSAiICsgZG9jLmtiRGF0YS5yZW1vdGVVc2VyICsgIiBhdCAiICsgbm93MCArICI8YnIvPiIpOyAvL0VSUzE3MDkwOSAjNDA1OTIKICAgICBhcnJPZlBhaXJzLnB1c2goIlhfYnV0dG9uQWN0aW9uIiwgIiIpOwogICAgICovCiAgICBzZXREb2NTZXRTdGF0dXMoZG9jLCBhcnJPZlBhaXJzKTsKfQp1cGRhdGVEQihkb2MsIGFyck9mUGFpcnMpOwoKdmFyIGF0dGFjaFBhdGggPSBYKGRvYywgIlhfYXR0YWNoZWRUbyIpOwphbGVydCgiQEBAQEBAIEN1cnJlbnRseSBhdHRhY2hlZCB0byBaUEFQRVJfX3pTdGFja19fYyB3aXRoIElEOiAiICsgcGFyZW50U2ZTdGFja0lkKTsKCi8qIFNQTElUIE9GRiBORVcgU05JUFBFVCBIRVJFICovCnZhciBvcmdEb2NJZCA9IGRvYy5kYklEOwp2YXIgcmVzcG9uc2UgPSBzcGxpdERvY3VtZW50Rm9ySW5kZXgoZG9jLCAiaW5kZXgiLCBwYWdlUmFuZ2UpOwphbGVydCgic3BsaXREb2N1bWVudEZvckluZGV4IHJlc3BvbnNlID0gIiArIHJlc3BvbnNlKTsKYWxlcnQoIkNhc2UgJyIgKyBjYXNlSWQgKyAiJyBhbmQgbGVuID0gIiArIGNhc2VJZC5sZW5ndGgpOwoKdmFyIGNoaWxkRG9jSWQgPSBkb2MuZGJJRAphbGVydCgiY2hpbGREb2NJZCA9ICIgKyBjaGlsZERvY0lkKTsKCi8vKgovKiBBRlRFUiBUSElTIFBPSU5ULCBUSEUgRE9DIFdJTEwgSE9MRCBEQVRBIEZPUiBORVcgU05JUFBFVCwgTk9UIFRIRSBTVEFDSyBTTklQUEVUICovCi8vKgoKLyoKIDEuIHVwZGF0ZSBvcmlnaW5hbCB6U3RhY2sKIDIuID8gdW5sb2NrRG9jdW1lbnQKIDMuID8gbW92ZURvY3VtZW50CiA0LiB0cmFjawogNS4gY3JlYXRlQW5kQXR0YWNoIGNoaWxkIHN0YWNrCiA2LiB1cGRhdGVEQgogNy4gPyBtb3ZlRG9jdW1lbnQKICovCgovKiAxLiB1cGRhdGUgb3JpZ2luYWwgelN0YWNrICovCi8vTVNIMTgxMDAzIHRoaXMgc2hvdWxkIGJlIGRvbmUgaW4gU3RhY2sgQ29tcGxldGUsIG5vdCBoZXJlCi8vYXJyT2ZQYWlycyA9IFtdOwp2YXIgenAgPSAiWlBBUEVSX18iOyAvL0VSUzE3MDYyNiBub3cgaW4gdGhlIHBhY2thZ2UKdmFyIHpTdGFjayA9IHpwICsgInpTdGFja19fYyI7IC8vIlN0YWNrX19jIgovL2Fyck9mUGFpcnMucHVzaCh6cCArICJTdGF0dXNfX2MiLCAiQ29tcGxldGVkIik7Ci8vdXBkYXRlU0ZSZWNvcmQoZG9jLCAiWlBBUEVSX196U3RhY2tfX2MiLCBzZlN0YWNrSWQsIGFyck9mUGFpcnMpOwoKLyoKIDIuID8gdW5sb2NrRG9jdW1lbnQKIDMuID8gbW92ZURvY3VtZW50CiAqLwp1bmxvY2tEb2N1bWVudChkb2MpOwptb3ZlRG9jdW1lbnQoZG9jLCBudWxsLCBwYXJlbnRGb2xkZXIpOwoKCi8qIDQuIHRyYWNrICovCnZhciBwYWdlQ291bnQgPSB6RGF0YS5jb3VudFBhZ2VzKGRvYywgcGFnZVJhbmdlKTsKdHJhY2soZG9jLCAiRG9jIEluZGV4ZWQgIiwgIkRvY3VtZW50IHdpdGggSWQ6ICIgKyBkb2MuZGJJRCwgcGFnZUNvdW50KTsKYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICJuZXh0UGFnZSh+cmVhZHl+KTt1cGRhdGVERVN0YXR1cyh+aW5kZXhlZDoiICsgcGFnZVJhbmdlICsgIn4pOyIpOwoKCi8qIDUuIGNyZWF0ZUFuZEF0dGFjaCBjaGlsZCBzdGFjayAqLwphcnJPZlBhaXJzID0gW107CmFyck9mUGFpcnMucHVzaCh6cCArICJmYXhUeXBlX19jIiwgelR5cGUpOwphcnJPZlBhaXJzLnB1c2goenAgKyAiUHJpb3JpdHlfX2MiLCAiTWVkaXVtIik7CmFyck9mUGFpcnMucHVzaCh6cCArICJTdGF0dXNfX2MiLCAiTmV3IFN0YWNrIik7CmFyck9mUGFpcnMucHVzaCh6cCArICJDaGFubmVsX19jIiwgIkZheCIpOwphcnJPZlBhaXJzLnB1c2goenAgKyAibGF0ZXN0RmF4X19jIiwgZm9ybWF0Tm93KTsKYXJyT2ZQYWlycy5wdXNoKHpwICsgInJlY2VpdmVkSWRfX2MiLCBkb2MuZGJJRCk7CmFyck9mUGFpcnMucHVzaCh6cCArICJuZXdGYXhfX2MiLCAidHJ1ZSIpOwphcnJPZlBhaXJzLnB1c2goenAgKyAiUGFnZXNfX2MiLCBwYWdlQ291bnQpOwphcnJPZlBhaXJzLnB1c2goIkdyb3VwX0lEX19jIiwgZ3JvdXBJRCk7CmFyck9mUGFpcnMucHVzaCgiSW1hZ2VfSURzX19jIiwgaW1hZ2VzRm9yVGhpc1N0YWNrKTsKYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfek5hdGl2ZUZpbGVOYW1lX19jIiwgbmF0aXZlRmlsZU5hbWUpOwppZiAoekRhdGEub3duZXJJZCkgewogICAgYXJyT2ZQYWlycy5wdXNoKCJPd25lcklkIiwgekRhdGEub3duZXJJZCk7Cn0KaWYgKHpEYXRhLnByb2dyYW1OYW1lKSB7CiAgICBhcnJPZlBhaXJzLnB1c2goenAgKyAiUHJvZ3JhbV9OYW1lX19jIiwgekRhdGEucHJvZ3JhbU5hbWUpOwp9CmFyck9mUGFpcnMucHVzaCh6cCArICJzZW50RmF4VG9fX2MiLCBkb2MuZGVsaXZlcmVkVG8pOyAvL0VSUzE3MDYyOCBjYWxsZXIgaWQKYXJyT2ZQYWlycy5wdXNoKHpwICsgIkZyb21fX2MiLCBkb2MuZGVsaXZlcmVkRnJvbSk7CmFyck9mUGFpcnMucHVzaCh6cCArICJTdGFnZV9fYyIsICJSZWNlaXZlZCIpOyAvL0VSUzE3MDczMSAjNDA1OTMKaWYgKHpEYXRhLnByb2dyYW1JZCkgewogICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfUHJvZ3JhbV9fYyIsIHpEYXRhLnByb2dyYW1JZCk7Cn0KaWYgKHpEYXRhLmNsYXNzaWZpY2F0aW9uKSB7CiAgICBhcnJPZlBhaXJzLnB1c2goenAgKyAiQ2xhc3NpZmljYXRpb25fX2MiLCB6RGF0YS5jbGFzc2lmaWNhdGlvbik7Cn0KYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX1BhcmVudF9fYyIsIHBhcmVudFNmU3RhY2tJZCk7Cgp2YXIgY2hpbGRTdGFja1NGSWQgPSBjcmVhdGVBbmRBdHRhY2goZG9jLCB6U3RhY2ssICJ6U3RhY2sgc3BsaXQgb24gIiArIGZvcm1hdE5vdywgYXJyT2ZQYWlycykgKyAiIjsKYWxlcnQoIiMjIyMgU3RhY2sgUmVjZWl2ZWQuIEF0dGFjaGVkIHRvOiAiICsgY2hpbGRTdGFja1NGSWQpOwp2YXIgY2hpbGRTdGFja051bWJlciA9IGdldFNGRmllbGQoZG9jLCB6U3RhY2ssICJOYW1lIiwgbnVsbCwgY2hpbGRTdGFja1NGSWQpOwovL2J1aWxkaW5nIGF0dGFjaG1lbnQgbmFtZSBQYXRpZW50TmFtZSsiLVN0YWNrIyIrelN0YWNrTmFtZSsiLSIrZG9jVHlwZSsiLSIrZm9ybWF0Tm93CnZhciBhdHRhY2htZW50TmFtZSA9ICIiOwppZiAocGF0aWVudE5hbWUpIHsKICAgIGF0dGFjaG1lbnROYW1lICs9IHBhdGllbnROYW1lICsgIi0iOwp9IGVsc2UgewogICAgYXR0YWNobWVudE5hbWUgKz0gcGF0aWVudEZpcnN0TmFtZSArICIgIiArIHBhdGllbnRMYXN0TmFtZSArICItIjsKfQphdHRhY2htZW50TmFtZSArPSAiU3RhY2sjIiArIGNoaWxkU3RhY2tOdW1iZXIucmVwbGFjZSgvXjArLywgIiIpICsgIi0iICsgZG9jVHlwZSArICItIiArIGZvcm1hdE5vdzsKCi8qIEF0dGFjaCB0aGUgc3BsaXQgZG9jdW1lbnQgdG8gYSBuZXcgQ2FzZSByZWNvcmQsIGlmIGl0IHdhc24ndCBwYXNzZWQgaW4gKi8KdmFyIHByaW9yaXR5ID0gWChkb2MsICJYX1pQQVBFUl9fUHJpb3JpdHlfX2MiKTsgLy9FUlMxNzA2MjYKLy9NU0gxODA5MjQgdW51c2VkIHZhciBsYWJlbDA9IiI7Ci8vTVNIMTgwOTI0IHVudXNlZCB2YXIgdHJpYWdlVHlwZT1kb2MuZG9jVHlwZTsKCi8qIEF0dGFjaCB0aGUgc3BsaXQgZG9jdW1lbnQgdG8gQ29udGFjdCByZWNvcmQgaWYgcmVxdWlyZWQgKi8KYWxlcnQoIkBAQEAgYXR0YWNoaW5nIHRvIGEgQ29udGFjdD8gY29udGFjdElkID0gIiArIGNvbnRhY3RJZCk7CmlmIChjb250YWN0SWQgJiYgY29udGFjdElkLmxlbmd0aCA+IDApIHsKICAgIGlmIChkb2NUeXBlICYmIGRvY1R5cGUubGVuZ3RoID4gMCAmJiAiUE9BIiA9PT0gZG9jVHlwZSkgewogICAgICAgIGF0dGFjaChkb2MsIGF0dGFjaG1lbnROYW1lLCBjb250YWN0SWQpOwogICAgICAgIGlmIChhdHRhY2hQYXRoLmluZGV4T2YoY29udGFjdElkKSA9PSAtMSkgewogICAgICAgICAgICBhdHRhY2hQYXRoICs9ICIsIiArIGNvbnRhY3RJZDsKICAgICAgICB9CiAgICAgICAgdGlmZlNmSWQgPSBjb250YWN0SWQ7CiAgICB9CiAgICB2YXIgY29udGFjdEZsZHMgPSBnZXRTRkZpZWxkcyhkb2MsICJDb250YWN0IiwgIkZpcnN0TmFtZSxMYXN0TmFtZSIsIG51bGwsIGNvbnRhY3RJZCk7CiAgICBwYXRpZW50Rmlyc3ROYW1lID0gWChkb2MsICJGaXJzdE5hbWUiLCBjb250YWN0Rmxkcyk7CiAgICBwYXRpZW50TGFzdE5hbWUgPSBYKGRvYywgIkxhc3ROYW1lIiwgY29udGFjdEZsZHMpOwp9IGVsc2UgaWYgKHBhdGllbnRGaXJzdE5hbWUgJiYgcGF0aWVudEZpcnN0TmFtZS5sZW5ndGggPiAwICYmIHBhdGllbnRMYXN0TmFtZSAmJiBwYXRpZW50TGFzdE5hbWUubGVuZ3RoID4gMCAmJiBwYXRpZW50RE9CICYmIHBhdGllbnRET0IubGVuZ3RoID4gMCkgewogICAgLyogQ3JlYXRlIG5ldyBjb250YWN0ICovCiAgICB2YXIgY3RjQXJyT2ZQYWlycyA9IFtdOwogICAgY3RjQXJyT2ZQYWlycy5wdXNoKCJGaXJzdE5hbWUiLCBwYXRpZW50Rmlyc3ROYW1lKTsKICAgIGN0Y0Fyck9mUGFpcnMucHVzaCgiTGFzdE5hbWUiLCBwYXRpZW50TGFzdE5hbWUpOwogICAgY3RjQXJyT2ZQYWlycy5wdXNoKCJCaXJ0aGRhdGUiLCBwYXRpZW50RE9CKTsKICAgIGN0Y0Fyck9mUGFpcnMucHVzaCgiT3duZXJJZCIsIHNmVXNlcklkKTsKICAgIGlmICh6RGF0YS5wcm9ncmFtSWQpIHsKICAgICAgICBjdGNBcnJPZlBhaXJzLnB1c2goIlByb2dyYW1yZWZfX2MiLCB6RGF0YS5wcm9ncmFtSWQpOwogICAgfQogICAgLyogYXR0YWNoIGRvY3VtZW50IHRvIGNvbnRhY3QgaWYgZG9jVHB5ZSBpcyBQT0EgKi8KICAgIGlmIChkb2NUeXBlICYmIGRvY1R5cGUubGVuZ3RoID4gMCAmJiAiUE9BIiA9PT0gZG9jVHlwZSkgewogICAgICAgIGNvbnRhY3RJZCA9IGNyZWF0ZUFuZEF0dGFjaChkb2MsICJDb250YWN0IiwgYXR0YWNobWVudE5hbWUsIGN0Y0Fyck9mUGFpcnMpOwogICAgICAgIGlmIChhdHRhY2hQYXRoLmluZGV4T2YoY29udGFjdElkKSA9PSAtMSkgewogICAgICAgICAgICBhdHRhY2hQYXRoICs9ICIsIiArIGNvbnRhY3RJZDsKICAgICAgICB9CiAgICAgICAgdGlmZlNmSWQgPSBjb250YWN0SWQ7CiAgICB9IGVsc2UgewogICAgICAgIC8qIGVsc2Ugb25seSBjcmVhdGUgY29udGFjdCAqLwogICAgICAgIGNvbnRhY3RJZCA9IGNyZWF0ZVNGUmVjb3JkKGRvYywgIkNvbnRhY3QiLCBhdHRhY2htZW50TmFtZSwgY3RjQXJyT2ZQYWlycyk7CiAgICB9CgogICAgLy9hbGVydCgiQEBAQEBAQCBET0NTIFBBUkFNUyA6ICIgKyBkb2MudG9TdHJpbmcoKSk7CiAgICBhbGVydCgiQEBAQEBAQCBORVcgQ09OVEFDVCBQQVJBTVM6ICIgKyBjdGNBcnJPZlBhaXJzKTsKICAgIGFsZXJ0KCJAQEBAQEBAIE5FVyBDT05UQUNUIENSRUFURUQgV0lUSCBJRDogIiArIGNvbnRhY3RJZCk7CiAgICBpZiAoY29udGFjdElkICE9ICJORVciKSB7CiAgICAgICAgLy8gY2xlYXIgb3V0IHRoZSAiTmV3IFBhdGllbnQiIGZpZWxkcwogICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX0ZpcnN0TmFtZV9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyAiIiArIGRxICsgIik7ICIpOwogICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX0xhc3ROYW1lX19jIiArIGRxICsgIikudmFsKCIgKyBkcSArICIiICsgZHEgKyAiKTsgIik7CiAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fQmlydGhkYXRlX19jIiArIGRxICsgIikudmFsKCIgKyBkcSArICIiICsgZHEgKyAiKTsgIik7CiAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fQmlydGhkYXRlX19jX3JlYWRhYmxlIiArIGRxICsgIikudmFsKCIgKyBkcSArICJOT05FIiArIGRxICsgIik7ICIpOwogICAgICAgIC8vIHNldCB0aGUgUGF0aWVudCBsb29rdXAgZmllbGRzCiAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fUGF0aWVudF9fYyIgKyBkcSArICIpLnZhbCgiICsgZHEgKyBjb250YWN0SWQgKyBkcSArICIpOyAiKTsKICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIiAkKCIgKyBkcSArICIjWlBBUEVSX19QYXRpZW50X19jX05hbWUiICsgZHEgKyAiKS52YWwoIiArIGRxICsgcGF0aWVudEZpcnN0TmFtZSArICIgIiArIHBhdGllbnRMYXN0TmFtZSArIGRxICsgIik7ICIpOwogICAgfQp9CmFsZXJ0KCJ1c2VyQ2xhc3NpZmljYXRpb24gPSAiICsgdXNlckNsYXNzaWZpY2F0aW9uKTsKYWxlcnQoInpEYXRhLnNraXBDYXNlVHlwZUlkID0gIiArIHpEYXRhLnNraXBDYXNlVHlwZUlkKTsKLy9hbGVydCgiekRhdGEuc2tpcENhc2VUeXBlSWQiICsgekRhdGEuc2tpcENhc2VUeXBlSWQuaW5kZXhPZihjYXNlUmVjb3JkVHlwZSkpOwoKLy9sZXRzIGNyZWF0ZSBuZXcgY2FzZSBpZiBjYXNlSWQgaXMgZW1wdHkKaWYgKCgoIWNhc2VJZCB8fCAwID09PSBjYXNlSWQubGVuZ3RoKSAmJiAiUE9BIiAhPSBkb2NUeXBlKSAmJiAhKHVzZXJDbGFzc2lmaWNhdGlvbiA9PSAiQ29zZW50eXgiICYmIHpEYXRhLnNraXBDYXNlVHlwZUlkICYmIHpEYXRhLnNraXBDYXNlVHlwZUlkLmluZGV4T2YoY2FzZVJlY29yZFR5cGUpID49IDApKSB7CiAgICBhbGVydCgiQEBAQCBjcmVhdGluZyBuZXcgQ2FzZSIpOwogICAgYXJyT2ZQYWlycyA9IFtdOwogICAgLy9FUlMxNzA1MjAgYXJyT2ZQYWlycy5wdXNoKCJPd25lcklkIiwgcXVldWVzTWFwS2x1ZGdlW1goZG9jLCAiWF9Bc3NpZ25fdG9fUXVldWVfX2MiKV0pOwogICAgYXJyT2ZQYWlycy5wdXNoKCJDb250YWN0SWQiLCBjb250YWN0SWQpOwogICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX25ld0ZheF9fYyIsICJ0cnVlIik7IC8vSlBCIDE3MDUxMiBhZGRlZCB0aGVzZSB3b3JrZmxvdyBmaWVsZHMKICAgIGFyck9mUGFpcnMucHVzaCgiUmVjZWl2ZWRfRGF0ZV9fYyIsIHJlY2VpdmVkQXQpOyAgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcwogICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX3JlY2VpdmVkSWRfX2MiLCBkb2MuZGJJRCk7IC8vSlBCIDE3MDUxMiBhZGRlZCB0aGVzZSB3b3JrZmxvdyBmaWVsZHMKICAgIGFyck9mUGFpcnMucHVzaCgiU3RhdHVzIiwgWChkb2MsICJYX1N0YXR1cyIpKTsKICAgIGFyck9mUGFpcnMucHVzaCgiT3duZXJJZCIsIHNmVXNlcklkKTsKICAgIGFyck9mUGFpcnMucHVzaCgiUmVjb3JkVHlwZUlkIiwgY2FzZVJlY29yZFR5cGUpOwogICAgaWYgKHpEYXRhLnByb2dyYW1JZCkgewogICAgICAgIGFyck9mUGFpcnMucHVzaCgiUHJvZ3JhbV9fYyIsIHpEYXRhLnByb2dyYW1JZCk7CiAgICB9CiAgICBhcnJPZlBhaXJzLnB1c2goIlNvdXJjZV9fYyIsIHpEYXRhLnNvdXJjZU5hbWUpOwogICAgLy9NU0gxODA0MDggYXJyT2ZQYWlycy5wdXNoKCJQcmltYXJ5X1Byb2R1Y3RfX2MiLCB6RGF0YS5wcm9kdWN0SWQpOwogICAgaWYgKHpEYXRhLnByb2R1Y3RJZCkgewogICAgICAgIGFyck9mUGFpcnMucHVzaCgiUHJpbWFyeV9Qcm9kdWN0X19jIiwgekRhdGEucHJvZHVjdElkKTsKICAgIH0KICAgIC8vYXJyT2ZQYWlycy5wdXNoKCJUeXBlIiwgIk5ldyBGYXgiKTsgLy9KUEIgMTcwNTEyIGFkZGVkIHRoZXNlIHdvcmtmbG93IGZpZWxkcy8vS1BTIDE3MTEwOSBjb21tZW50ZWQgb3V0IHBlciBDYXNlIzQzNDk3CiAgICBpZiAoMSA9PSAxKSB7IC8vRVJTMTcwNTIzICMzNzE2MiBhZnRlciBkcnlydW4KICAgICAgICAvL2Fyck9mUGFpcnMucHVzaCgiUmVjb3JkVHlwZUlkIiwiMDEyUTAwMDAwMDA1QWhqIik7IC8vRVJTMTcwNTIzIFByaW9yIEF1dGgKICAgICAgICBpZiAocHJpb3JpdHkgIT0gIk5vcm1hbCIpIHsKICAgICAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJQcmlvcml0eSIsIHByaW9yaXR5KTsgIC8vRVJTMTcwNTI0ICMzNzE2MiBwcmlvcml0eSBvbiBDYXNlCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJQcmlvcml0eSIsICJNZWRpdW0iKTsKICAgICAgICB9CiAgICAgICAgYXJyT2ZQYWlycy5wdXNoKCJPcmlnaW4iLCAiRmF4Iik7CiAgICB9CiAgICBhbGVydCgiYXJyT2ZQYWlycyBDYXNlICoqKioqKioqKioqKjogIiArIGFyck9mUGFpcnMpOwogICAgLy92YXIgY2FzZUlkID0gY3JlYXRlQW5kQXR0YWNoKGRvYywgIkNhc2UiLCBhdHRhY2htZW50TmFtZSwgYXJyT2ZQYWlycyk7CiAgICBpZiAoIWRvY1R5cGUgfHwgKGRvY1R5cGUgJiYgZG9jVHlwZS5sZW5ndGggPiAwICYmICJQT0EiICE9IGRvY1R5cGUpKSB7CiAgICAgICAgY2FzZUlkID0gY3JlYXRlQW5kQXR0YWNoKGRvYywgIkNhc2UiLCBhdHRhY2htZW50TmFtZSwgYXJyT2ZQYWlycyk7CiAgICAgICAgaWYgKGF0dGFjaFBhdGguaW5kZXhPZihjYXNlSWQpID09IC0xKSB7CiAgICAgICAgICAgIGF0dGFjaFBhdGggKz0gIiwiICsgY2FzZUlkOwogICAgICAgIH0KICAgICAgICB0aWZmU2ZJZCA9IGNhc2VJZDsKICAgIH0gZWxzZSB7CiAgICAgICAgY2FzZUlkID0gY3JlYXRlU0ZSZWNvcmQoZG9jLCAiQ2FzZSIsIGF0dGFjaG1lbnROYW1lLCBhcnJPZlBhaXJzKTsKICAgIH0KICAgIC8vaWYgY2FzZSBnZXQgY3JlYXRlZCBzdWNjZXNzZnVsbHkgdGhlbiBsZXQncyB1cGRhdGUgbG9va3VwIGZpZWxkIGluIHRyaWFnZSBmb3JtCiAgICBpZiAoY2FzZUlkICE9ICJORVciKSB7CiAgICAgICAgdmFyIGNhc2VGbGRzID0gZ2V0U0ZGaWVsZHMoZG9jLCAiQ2FzZSIsICJDYXNlTnVtYmVyIiwgbnVsbCwgY2FzZUlkKTsKICAgICAgICB2YXIgY2FzZU51bWJlciA9IFgoZG9jLCAiQ2FzZU51bWJlciIsIGNhc2VGbGRzKTsKICAgICAgICAvL2xldHMgdXBkYXRlIGNhc2UgbG9va3VwIGRldGFpbHMgaGVyZQogICAgICAgIGFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAiICQoIiArIGRxICsgIiNaUEFQRVJfX0Nhc2VfX2MiICsgZHEgKyAiKS52YWwoIiArIGRxICsgY2FzZUlkICsgZHEgKyAiKTsgIik7CiAgICAgICAgYWRkUG9zdEV4ZWN1dGlvblNjcmlwdChkb2MsICIgJCgiICsgZHEgKyAiI1pQQVBFUl9fQ2FzZV9fY19DYXNlTnVtYmVyIiArIGRxICsgIikudmFsKCIgKyBkcSArIGNhc2VOdW1iZXIgKyBkcSArICIpOyAiKTsKICAgICAgICAvL0Nhc2UgcmVkaXJlY3Rpb24gaGVyZQogICAgICAgIC8vTVNIMTgwNDA4IENhc2UgcmVjb3JkLCBub3QgUGF0aWVudCByZWNvcmQKICAgICAgICBhZGRQb3N0RXhlY3V0aW9uU2NyaXB0KGRvYywgIjtpZihjb25maXJtKCdWaWV3IG5ld2x5LWNyZWF0ZWQgQ2FzZSBSZWNvcmQnKSl7IGxvY2F0aW9uLmhyZWY9JyIgKyBkb2Muc2ZTZXJ2ZXIgKyAiL2FwZXgvSW50YWtlUGFnZT9pZD0iICsgY2FzZUlkICsgIid9Iik7CiAgICB9CiAgICBhbGVydCgiQ3JlYXRlZCBDYXNlIHdpdGggSUQ6ICIgKyBjYXNlSWQpOwogICAgaWYgKGNhc2VJZCA9PSAibnVsbCIgfHwgY2FzZUlkID09ICJORVciKSB7CiAgICAgICAgY2FzZUlkID0gbnVsbDsgLy9FUlMxNzA2MjEgVE9ETyBuZWVkIGEgc3RhbmRhcmQKICAgIH0KfSBlbHNlIHsKICAgIC8vYXR0YWNoIGRvY3VtZW50IHRvIGV4aXN0aW5nIGNhc2UgaWYgZG9jVHlwZSBub3QgZXF1YWxzIFBPQQogICAgaWYgKGRvY1R5cGUgJiYgZG9jVHlwZS5sZW5ndGggPiAwICYmICJQT0EiICE9IGRvY1R5cGUpIHsKICAgICAgICBhbGVydCgiQEBAQCBhdHRhY2hpbmcgdG8gZXhpc3RpbmcgQ2FzZTogIiArIGNhc2VJZCk7CiAgICAgICAgYXR0YWNoKGRvYywgYXR0YWNobWVudE5hbWUsIGNhc2VJZCk7CiAgICAgICAgaWYgKGF0dGFjaFBhdGguaW5kZXhPZihjYXNlSWQpID09IC0xKSB7CiAgICAgICAgICAgIGF0dGFjaFBhdGggKz0gIiwiICsgY2FzZUlkOwogICAgICAgIH0KICAgICAgICB0aWZmU2ZJZCA9IGNhc2VJZDsKICAgIH0KfQoKLy8gbGV0cyBjcmVhdGUgdGlmZiBpbWFnZSBmb3IgcGRmIGhlcmUKYWxlcnQoIiMjIyB0aWZmIGZsYWcgIyMjID0gIiArIHpEYXRhLmdlbmVyYXRlVGlmZik7CmFsZXJ0KCIjIyMgcGFnZVJhbmdlICMjIyA9ICIgKyBwYWdlUmFuZ2UpOwphdHRhY2goZG9jLCBhdHRhY2htZW50TmFtZSwgcGFyZW50U2ZTdGFja0lkKTsKaWYgKHpEYXRhLmdlbmVyYXRlVGlmZikgewogICAgc2V0RG9jdW1lbnRDb250ZXh0KGRvYywgb3JnRG9jSWQpOwogICAgLyogTVNIMTgwMTMwICM0NDk4NiBjcmVhdGUgYW5kIGF0dGFjaCB0aWYgKi8KICAgIC8qIEF0dGFjaCBmaWxlIGluIGFkZGl0aW9uIHRvIGVudmVsb3BlICovCiAgICB2YXIgbm93VGltZVN0YW1wID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgKyAiIjsKICAgIC8vZm91bmQgaW4gL3pwZGF0YS9jb25mL3dvcmtmbG93LnByb3BzCiAgICAvL2EgZGlyZWN0b3J5IGluIHdoaWNoIHRvIGRvIHRoZSB3b3JrCiAgICAvL2ludGVncmF0aW9uRGlyPS96cGRhdGEvYWdlbnRzL21jay9pbnRlZ3JhdGlvbi8KICAgIGNyZWF0ZURpcmVjdG9yeShkb2MsIHpEYXRhLnVwbG9hZERpciwgbm93VGltZVN0YW1wKTsKICAgIC8vTVNIMTgxMDA0IHVudXNlZCB2YXIgc3RhY2tOYW1lID0gZ2V0U0ZGaWVsZChkb2MsICJaUEFQRVJfX3pTdGFja19fYyIsICJOYW1lIiwgIiIsIHNmU3RhY2tJZCk7CiAgICAvL01TSDE4MDkyNCB1bnVzZWQgdmFyIGZpbGVOYW1lID0gZ2V0Q3VyRGF0ZShkb2MpICsgIiBTdGFjayAiICsgc3RhY2tOYW1lICsgIiBOZXcgIit6RGF0YS5wcm9ncmFtTmFtZSsiIEZheC5wZGYiOwoKICAgIC8vUGFnZSBSYW5nZSBjYW4gY29udGFpbiBub24tbnVtZXJpYyBjaGFyYWN0ZXJzIGZyb20gUGFnZSBSb3RhdGlvbiBlZzojIyMgcGFnZVJhbmdlICMjIzF1LDIsOCw3LDYsNSw0LDMKICAgIC8vbWFrZSBzdXJlIHBhZ2UgcmFuZ2UgYXJyYXkgaXMgY2xlYXJlZCBvZiBhbGwgbm9uLW51bWVyaWMgY2hhcnMKICAgIC8vTVNIMTgwOTI0IGRvbid0IG5lZWQgbWluICYgbWF4LCBqdXN0IHN0cmlwIG91dCBhbHBoYSBjaGFycy4KICAgIC8vICAgICAgcGFyc2luZyBpcyBoYW5kbGVkIGRvd25zdHJlYW0gaW4gY29tLmtub3dsZWRnZWJpbi5VdGlscyBwdWJsaWMgc3RhdGljIENvbGxlY3Rpb248SW50ZWdlcj4gcGFyc2VQYWdlcyhTdHJpbmcgcGFnZXMpCiAgICAvL3ZhciBtYXhQYWdlID0gTWF0aC5tYXguYXBwbHkoTWF0aCwgcGFnZVJhbmdlLnNwbGl0KCcsJykpOwogICAgLy92YXIgbWluUGFnZSA9IE1hdGgubWluLmFwcGx5KE1hdGgsIHBhZ2VSYW5nZS5zcGxpdCgnLCcpKTsKICAgIC8vYWxlcnQoIiMjIyBBbGwgbWluIG1heCAjIyMiICsgbWluUGFnZSArICItIiArIG1heFBhZ2UpOwogICAgLy9hbGVydCgiQEBAQEAgQ2FsbGluZyBzcGxpdCwgcGFnZXMgPSAiICsgbWluUGFnZSArICItIiArIG1heFBhZ2UgKyAiLCBub3dUaW1lU3RhbXAgPSAiICsgbm93VGltZVN0YW1wKTsKCiAgICAvL3JlZ2V4OiBmaW5kIGFsbCBhbHBoYSBjaGFycyAoW2Etel0pLCBnbG9iYWxseSAoZyksIGFuZCBjYXNlLWluc2Vuc2l0aXZlIChpKQogICAgdmFyIG5vQWxwaGFQYWdlcyA9IHBhZ2VSYW5nZS5yZXBsYWNlKC9bYS16XS9naSwgIiIpOwogICAgYWxlcnQoIkBAQEBAIENhbGxpbmcgc3BsaXQsIHBhZ2VzID0gIiArIG5vQWxwaGFQYWdlcyArICIsIG5vd1RpbWVTdGFtcCA9ICIgKyBub3dUaW1lU3RhbXApOwoKICAgIC8vTVNIMTgwOTI0ICM1MjQ0MCB2YXIgcmVzcG9uc2UgPSBzcGxpdFBERihkb2MsIG1pblBhZ2UgKyAiLSIgKyBtYXhQYWdlLCB6RGF0YS51cGxvYWREaXIsIG5vd1RpbWVTdGFtcCwgZG9jLmRiSUQpOwogICAgdmFyIHJlc3BvbnNlID0gc3BsaXRQREYoZG9jLCBub0FscGhhUGFnZXMsIHpEYXRhLnVwbG9hZERpciwgbm93VGltZVN0YW1wLCBkb2MuZGJJRCk7CiAgICBhbGVydCgiQEBAQCByZXNwb25zZSBmcm9tIHNwbGl0UERGID0gIiArIHJlc3BvbnNlKTsKICAgIHZhciBuZXdQREZOYW1lID0gWChkb2MsICJuZXdQREYiLCByZXNwb25zZSk7CiAgICBhbGVydCgiQEBAQCBzcGxpdCBQREYgRmlsZU5hbWUgPSAiICsgbmV3UERGTmFtZSk7CiAgICB2YXIgbmV3VElGRk5hbWUgPSBwZGYydGlmZihkb2MsIG5ld1BERk5hbWUpOwogICAgYWxlcnQoIkBAQEAgcGRmMnRpZmYgRmlsZU5hbWUgPSAiICsgbmV3VElGRk5hbWUpOwogICAgdmFyIGxhYmVsID0gYXR0YWNobWVudE5hbWUgKyAiLnRpZiI7CiAgICBpZiAobmV3VElGRk5hbWUuaW5kZXhPZigiRVJST1IiKSAhPT0gMCkgewogICAgICAgIHZhciB1cGxvYWRVUkwgPSAiaHR0cDovL2xvY2FsaG9zdDo4MDgwL215ZmlsZWZvcmNlL3VwbG9hZFRvQ2xvdWQuanNwP1NGaWQ9TkVXJlNGcGlkPSIgKyB0aWZmU2ZJZCArICImU0Zvcmc9IiArIGRvYy5zZk9yZyArICImbGFiZWw9IiArIGxhYmVsICsgIiZzZXJ2ZXJGaWxlPSIgKyBuZXdUSUZGTmFtZSArICImRGVzY3JpcHRpb249RmlsZSBhdHRhY2hlZCBieSB6UGFwZXIuIjsKICAgICAgICBhbGVydCgiIyMjIyBVcGxvYWQgbmF0aXZlIFBERiB3aXRoICIgKyB1cGxvYWRVUkwpOwogICAgICAgIHZhciByID0gd2dldChkb2MsIHVwbG9hZFVSTCk7CiAgICAgICAgYWxlcnQoIiMjIyMgdGlmZiBjcmVhdGVkIGFuZCBhdHRhY2hlZCB0bzogIiArIGNhc2VJZCk7CiAgICAgICAgY2xlYW51cERpcmVjdG9yeShkb2MsIHpEYXRhLnVwbG9hZERpciwgbm93VGltZVN0YW1wKTsKICAgICAgICAvKiBGaW5hbGx5LCBkZWxldGUgdGhlIHdvcmsgZm9sZGVyIGFuZCBhbGwgY29udGVudHMuICovCiAgICAgICAgLy9NU0gxNzAyMjIgRVJTIHdhbnRzIHRvIGtlZXAgY2xlYW51cERpcmVjdG9yeShkb2MsICJpbnRlZ3JhdGlvbkRpciIsIG5vd1RpbWVTdGFtcCk7CiAgICB9CiAgICAvL01TSDE4MTAwOCBzaW5jZSB3ZSBjaGFuZ2VkIHRoZSBkb2MgY29udGV4dCwgY2hhbmdlIGl0IGJhY2sKICAgIHNldERvY3VtZW50Q29udGV4dChkb2MsIGNoaWxkRG9jSWQpOwp9CgovL2xldHMgdXBkYXRlIHpTdGFjayByZWNvcmQgd2l0aCBwYXRpZW50IGFuZCBjYXNlIGRldGFpbHMKYXJyT2ZQYWlycyA9IFtdOwppZiAocHJvdmlkZXJJZCAmJiBwcm92aWRlcklkLmxlbmd0aCA+IDApIHsKICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19Qcm92aWRlcl9fYyIsIHByb3ZpZGVySWQpOwogICAgaWYgKGF0dGFjaFBhdGguaW5kZXhPZihwcm92aWRlcklkKSA9PSAtMSkgewogICAgICAgIGF0dGFjaFBhdGggKz0gIiwiICsgcHJvdmlkZXJJZDsKICAgIH0KfQppZiAoY29udGFjdElkICYmIGNvbnRhY3RJZC5sZW5ndGggPiAwKSB7CiAgICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fUGF0aWVudF9fYyIsIGNvbnRhY3RJZCk7CiAgICBpZiAoYXR0YWNoUGF0aC5pbmRleE9mKGNvbnRhY3RJZCkgPT0gLTEpIHsKICAgICAgICBhdHRhY2hQYXRoICs9ICIsIiArIGNvbnRhY3RJZDsKICAgIH0KfQppZiAoY2FzZUlkICYmIGNhc2VJZC5sZW5ndGggPiAwKSB7CiAgICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fQ2FzZV9fYyIsIGNhc2VJZCk7Cn0KaWYgKHBhdGllbnRGaXJzdE5hbWUgJiYgcGF0aWVudEZpcnN0TmFtZS5sZW5ndGggPiAwKSB7CiAgICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl9fRmlyc3ROYW1lX19jIiwgcGF0aWVudEZpcnN0TmFtZSk7Cn0KaWYgKHBhdGllbnRMYXN0TmFtZSAmJiBwYXRpZW50TGFzdE5hbWUubGVuZ3RoID4gMCkgewogICAgYXJyT2ZQYWlycy5wdXNoKCJaUEFQRVJfX0xhc3ROYW1lX19jIiwgcGF0aWVudExhc3ROYW1lKTsKfQppZiAocGF0aWVudERPQiAmJiBwYXRpZW50RE9CLmxlbmd0aCA+IDApIHsKICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19CaXJ0aGRhdGVfX2MiLCBwYXRpZW50RE9CKTsKfQppZiAoZG9jVHlwZSAmJiBkb2NUeXBlLmxlbmd0aCA+IDApIHsKICAgIGFyck9mUGFpcnMucHVzaCgiWlBBUEVSX19mYXhUeXBlX19jIiwgZG9jVHlwZSk7Cn0KLy9NU0gxODA5MjQgIzUyNDQwIHBvcHVsYXRlIGdyb3VwSUQsIGltYWdlSWRzLCBhbmQgek5hdGl2ZUZpbGVOYW1lIG9uIGNoaWxkIHN0YWNrCmlmIChncm91cElEKSB7CiAgICBhcnJPZlBhaXJzLnB1c2goIkdyb3VwX0lEX19jIiwgZ3JvdXBJRCk7Cn0KaWYgKG5hdGl2ZUZpbGVOYW1lKSB7CiAgICBhcnJPZlBhaXJzLnB1c2goIlpQQVBFUl96TmF0aXZlRmlsZU5hbWVfX2MiLCBuYXRpdmVGaWxlTmFtZSk7Cn0KaWYgKGltYWdlc0ZvclRoaXNTdGFjaykgewogICAgYXJyT2ZQYWlycy5wdXNoKCJJbWFnZV9JRHNfX2MiLCBpbWFnZXNGb3JUaGlzU3RhY2spOwp9Ci8vTVNIMTgwOTI0ICM1MjQ0MCBFTkQKCmFsZXJ0KCJAQEBAIEJlZm9yZSB1cGRhdGUgc3RhY2sgcmVjb3JkIGFyck9mUGFpcnMgPT09ICIgKyBhcnJPZlBhaXJzKTsKYWxlcnQoIkBAQEAgdXBkYXRlIHN0YWNrIHJlY29yZCBjaGlsZFN0YWNrU0ZJZCA9PT0gIiArIGNoaWxkU3RhY2tTRklkKTsKdXBkYXRlU0ZSZWNvcmQoZG9jLCAiWlBBUEVSX196U3RhY2tfX2MiLCBjaGlsZFN0YWNrU0ZJZCwgYXJyT2ZQYWlycyk7Ci8vYXR0YWNoKGRvYywgYXR0YWNobWVudE5hbWUsIHNmU3RhY2tJZCk7Ci8vYWxlcnQoIkBAQEAgdXBkYXRlZCB6U3RhY2sgUmVjb3JkLCBpZCA9ICIgKyBjaGlsZFN0YWNrU0ZJZCk7CgppZiAoMSA9PT0gMCkgeyAvL0VSUzE3MDYyNyBUT0RPIHJlZmFjdG9yCiAgICAvL0NSTjE3MDIwOCBJZiB3ZSBoYXZlIGEgQ29udGFjdCBhbmQgdGhlIHVzZXIgc2VudCBhIFByb3ZpZGVyLCBhZGQgdGhlIHByb3ZpZGVyIHRvIHRoZSBDb250YWN0LgogICAgdmFyIHByb3ZpZGVyID0gWChkb2MsICJYX1ByaW1hcnlfQ2FyZV9QaHlzaWNpYW5fX2MiKTsKICAgIGlmIChjb250YWN0SWQgJiYgY29udGFjdElkLmxlbmd0aCA+IDAgJiYgcHJvdmlkZXIgJiYgcHJvdmlkZXIubGVuZ3RoID4gMCkgewogICAgICAgIGFyck9mUGFpcnMgPSBbXTsKICAgICAgICBhcnJPZlBhaXJzLnB1c2goIlByaW1hcnlfQ2FyZV9QaHlzaWNpYW5fX2MiLCBwcm92aWRlcik7CiAgICAgICAgdXBkYXRlU0ZSZWNvcmQoZG9jLCAiQ29udGFjdCIsIGNvbnRhY3RJZCwgYXJyT2ZQYWlycyk7CiAgICB9Cn0KCi8qIE1vdmUgdGhlIHNwbGl0IGRvY3VtZW50IHRvIGl0cyBwcm9jZXNzaW5nIGZvbGRlciAqLwphbGVydCgiQEBAQEBAIE1vdmluZyB0aGUgaW5kZXhlZCBwYWdlcyBkb2N1bWVudCBpbnRvIG5leHQgcHJvY2Vzc2luZyBmb2xkZXI6ICIgKyBuZXh0Rm9sZGVyKTsKLy9tb3ZlRG9jdW1lbnQoZG9jLCIiLG5leHRGb2xkZXIpOwovL3JlbG9hZEJ5QkFURVMoZG9jLCBuZXh0Rm9sZGVyKTsgLy9FUlMxNzA0MTMgIzM1MjkxCi8qIFBsYWNlIHRoZSBzcGxpdCBkb2N1bWVudCBpbnRvIHRoZSBzdGFjayBmb2xkZXIgKi8KYWxlcnQoIkBAQEBAQCBNb3ZpbmcgdGhlIGluZGV4ZWQgcGFnZXMgZG9jdW1lbnQgaW50byB0aGUgZmluYWwgc3RhY2sgZm9sZGVyOiAiICsgc3RhY2tGb2xkZXIpOwovL21vdmVEb2N1bWVudChkb2MsIiIsc3RhY2tGb2xkZXIpOwpwYXJlbnRGb2xkZXIgPSBkb2Mua2JEYXRhLmdyb3VwSUQuc3Vic3RyaW5nKDEpICsgIkluIjsKbW92ZURvY3VtZW50KGRvYywgZG9jLnVzZXJJRCArICJJbiIsIHBhcmVudEZvbGRlcik7CnVubG9ja0RvY3VtZW50KGRvYyk7CgoKLyogNi4gdXBkYXRlREIgKi8KCmFyck9mUGFpcnMgPSBbXTsKLy9NU0gxODEwMDggZGVidWdnaW5nCmFsZXJ0KCJAQEBAIGNoaWxkIGRvYy5kYklEID0gIiArIGRvYy5kYklEKTsKYWxlcnQoIkBAQEAgcGFyZW50IGRvYy5kYklEID0gIiArIHBhcmVudGRiSUQpOwovL0VSUzE3MDkwOSBhcnJPZlBhaXJzLnB1c2goIlhfcmV2aWV3ZWRTdGF0dXMiLCAiSW5kZXhlZCIpOwppZiAoMSA9PT0gMSkgeyAvL0VSUzE3MDkwOSAjNDA1OTIgZm9yIHpEb2NTZXQgc3RhdHVzZXMKICAgIC8vTVNIMTgwOTI0IHVzZSBYKGRvYywgIm5ubm5ubm4iKSBpbnN0ZWFkIHZhciBiYSA9IGRvYy5YKCJYX2J1dHRvbkFjdGlvbiIpKyJlZCI7CiAgICAvKiBNU0gxODA5MjQgbW92ZWQgdG8gZnVuY3Rpb24gYWJvdmUKICAgICB2YXIgYmEgPSBYKGRvYywgIlhfYnV0dG9uQWN0aW9uIikgKyAiZWQiOwogICAgIGJhID0gYmEuc3Vic3RyaW5nKDEgKyBiYS5sYXN0SW5kZXhPZigiICIpKTsKICAgICB2YXIgbm93MCA9IGdldEN1ckRhdGVBbmRUaW1lKGRvYywgZmFsc2UsIHRydWUpOwogICAgIGFyck9mUGFpcnMucHVzaCgiWF9yZXZpZXdlZFN0YXR1cyIsIGJhKTsKICAgICBhcnJPZlBhaXJzLnB1c2goIlhfcmV2aWV3cyIsIFgoZG9jLCAiWF9yZXZpZXdzIikgKyBiYSArICIgYnkgIiArIGRvYy5rYkRhdGEucmVtb3RlVXNlciArICIgYXQgIiArIG5vdzAgKyAiPGJyLz4iKTsgLy9FUlMxNzA5MDkgIzQwNTkyCiAgICAgYXJyT2ZQYWlycy5wdXNoKCJYX2J1dHRvbkFjdGlvbiIsICIiKTsKICAgICAqLwogICAgc2V0RG9jU2V0U3RhdHVzKGRvYywgYXJyT2ZQYWlycyk7Cn0KLyogQ1JOMTYwODI1IFNldCB0aGUgcGFnZSBjb3VudCBzbyB0aGF0IGl0IGRvZXMgbm90IGhhdmUgdGhlIHBhcmVudCBwYWdlIGNvdW50ICovCnBhZ2VDb3VudCA9IHpEYXRhLmNvdW50UGFnZXMoZG9jLCBwYWdlUmFuZ2UpOwphbGVydCgiQEBAQCBwYWdlQ291bnQgPSAiICsgcGFnZUNvdW50KTsKYXJyT2ZQYWlycy5wdXNoKCJYX3BhZ2VzIiwgcGFnZUNvdW50KTsKYXJyT2ZQYWlycy5wdXNoKCJkYi1wYWdlcyIsIHBhZ2VDb3VudCk7CmFyck9mUGFpcnMucHVzaCgiZGItbGFiZWwiLCBwYXRpZW50Rmlyc3ROYW1lICsgcGF0aWVudExhc3ROYW1lICsgIiAtICIgKyBjb21wYW55Q29kZSArICIgLSAiICsgY2hpbGRTdGFja1NGSWQpOwphcnJPZlBhaXJzLnB1c2goImRiLUJBVEVTIiwgY2hpbGRTdGFja1NGSWQgKyAiLVNUQUNLIik7CmFyck9mUGFpcnMucHVzaCgiWF9zZlN0YWNrSWQiLCBjaGlsZFN0YWNrU0ZJZCk7Ci8vQ1JOMTgwNjE4IE1ha2Ugc3VyZSB0aGF0IHRoZSBsYXRlc3QgYXR0YWNobWVudCBpcyBmaXJzdCBpbiB0aGUgbGlzdCBiZWNhdXNlIGZpbGVzLmpzcGYgdXNlcyB0aGF0IGZpcnN0IG9uZSB0byBwdWxsIHByZS1wb3AgZGF0YS4KYXR0YWNoUGF0aCA9IFgoZG9jLCAiWF9hdHRhY2hlZFRvIik7CnZhciBhdHRhY2hJZHMgPSBhdHRhY2hQYXRoLnN1YnN0cmluZyhhdHRhY2hQYXRoLmxhc3RJbmRleE9mKCIvIikgKyAxKTsKYXR0YWNoSWRzID0gYXR0YWNoSWRzLnNwbGl0KCIsIik7CnZhciBidWZmZXIgPSBjaGlsZFN0YWNrU0ZJZCArICIiOwpmb3IgKHZhciBpZHggaW4gYXR0YWNoSWRzKSB7CiAgICBpZiAoYXR0YWNoSWRzLmhhc093blByb3BlcnR5KGlkeCkpIHsKICAgICAgICB2YXIgYXR0YWNoSWQgPSBhdHRhY2hJZHNbaWR4XTsKICAgICAgICBpZiAoYXR0YWNoSWQgIT09IGNoaWxkU3RhY2tTRklkKSB7CiAgICAgICAgICAgIGJ1ZmZlciArPSAiLCIgKyBhdHRhY2hJZDsKICAgICAgICB9CiAgICB9Cn0KYXR0YWNoUGF0aCA9IGF0dGFjaFBhdGguc3Vic3RyaW5nKDAsIGF0dGFjaFBhdGgubGFzdEluZGV4T2YoIi8iKSArIDEpICsgYnVmZmVyOwphbGVydCgiQEBAIG5ldyBYX2F0dGFjaGVkVG8gPSAiICsgYXR0YWNoUGF0aCk7CmFyck9mUGFpcnMucHVzaCgiWF9hdHRhY2hlZFRvIiwgYXR0YWNoUGF0aCk7CgppZiAoIXBhdGllbnRGaXJzdE5hbWUgfHwgMCA9PSBwYXRpZW50Rmlyc3ROYW1lLmxlbmd0aCkgewogICAgcGF0aWVudEZpcnN0TmFtZSA9ICJVbmtub3duIjsKfQppZiAoIXBhdGllbnRMYXN0TmFtZSB8fCAwID09IHBhdGllbnRMYXN0TmFtZS5sZW5ndGgpIHsKICAgIHBhdGllbnRMYXN0TmFtZSA9ICJOYW1lIjsKfQphcnJPZlBhaXJzLnB1c2goImRiLWxhYmVsIiwgcGF0aWVudEZpcnN0TmFtZSArIHBhdGllbnRMYXN0TmFtZSArICIgLSAiICsgY29tcGFueUNvZGUgKyAiIC0gIiArIGNoaWxkU3RhY2tTRklkKTsKdXBkYXRlREIoZG9jLCBhcnJPZlBhaXJzKTsKCnRyYWNrKGRvYywgIkRvYyBJbmRleGVkICIsICJEb2N1bWVudCB3aXRoIElkOiAiICsgZG9jLmRiSUQsIHBhZ2VDb3VudCk7CmFkZFBvc3RFeGVjdXRpb25TY3JpcHQoZG9jLCAibmV4dFBhZ2UofnJlYWR5fik7dXBkYXRlREVTdGF0dXMofmluZGV4ZWQ6IiArIHBhZ2VSYW5nZSArICJ+KTsiKTsKLyogRU5EIEluZGV4IFBhZ2UgKi8K"},"ordinal":7}

//--- RULE JSON REPRESENTATION - END ---

//--- RULE CONSEQUENCE CODE ---
/* BEGIN Index Page */
alert("@@@@ Index Rule Fired @@@#");
//MSH180924 #52440 populate groupID, imageIds, and zNativeFileName on child stack
function findMatchingImageIds(aPageRange, parentImageIdsArr) {
    var rtn = "";
    var pageRange = aPageRange;
    var pages = pageRange.split(",");
    if (pages.length > 1) {
        alert("pages.length > 1");
        for (var m = 0; m < pages.length; m++) {
            if (0 === rtn.length) {
                rtn = parentImageIdsArr[pages[m] - 1];
            } else {
                rtn += "," + parentImageIdsArr[pages[m] - 1];
            }
        }
    } else {
        rtn = parentImageIdsArr[pages[0] - 1];
    }
    return rtn;
}

//MSH180925 #52440 moved here from below so it's available
var pageRange = X(doc, "X_idxPages");
var groupID = X(doc, "GroupID");
var imageIDs = X(doc, "ImageIDs");

alert("#### full list of ImageIDs from parent stack: " + imageIDs);
var nativeFileName = X(doc, "zNativeFileName");
var imagesForThisStack = null;
if (imageIDs) {
    var imageIdsArr = imageIDs.split(",");
    alert("### parent images array = " + imageIdsArr);
    imagesForThisStack = findMatchingImageIds(pageRange, imageIdsArr);
}
//MSH181003 keep the array format correct
if (!imagesForThisStack) {
    imagesForThisStack = "";
}
alert("#### images for this stack = " + imagesForThisStack);
//MSH180924 #52440 END

function setDocSetStatus(aDoc, anArrOfPairs) {
    var ba = X(aDoc, "X_buttonAction") + "ed";
    ba = ba.substring(1 + ba.lastIndexOf(" "));
    var now0 = getCurDateAndTime(aDoc, false, true);
    anArrOfPairs.push("X_reviewedStatus", ba);
    anArrOfPairs.push("X_reviews", X(aDoc, "X_reviews") + ba + " by " + aDoc.kbData.remoteUser + " at " + now0 + "<br/>"); //ERS170909 #40592
    anArrOfPairs.push("X_buttonAction", "");
}
/* double-quote, newline characters */
var dq = String.fromCharCode(34);
//MSH180924 unused var nl = String.fromCharCode(10);
var formatNow = getCurDateAndTime(doc);
var stackId = X(doc, "X_stack");
var stackFolder = stackId + "-STACK";
var companyCode = doc.deliveredTo;
var tiffSfId = "";
var parentFolder = X(doc, "X_curFolder");
var parentdbID = doc.dbID; //JPB180606 added doc.dbID

/* Clear the trigger that invoked this rule */
//ERS170909 zData.clearTriggerCondition(doc,"X_buttonAction");
var indexInitialized = X(doc, "X_indexInitialized");
if (!indexInitialized || 0 === indexInitialized.length) {
    stackId = new Date().getTime() + "";
    stackFolder = stackId + "-STACK";
    zData.initializeStack(doc, stackFolder, companyCode, stackId);
}

// Does the user want to attach indexed pages to Case?
//var sfStackId = X(doc, "X_sfStackId");
var parentSfStackId = X(doc, "X_sfStackId");
var caseId = X(doc, "X_ZPAPER__Case__c");
var contactId = X(doc, "X_ZPAPER__Patient__c");
//MSH180924 unused var patientId = contactId; //TODO
var providerId = X(doc, "X_ZPAPER__Provider__c");
var patientFirstName = X(doc, "X_ZPAPER__FirstName__c");
var patientLastName = X(doc, "X_ZPAPER__LastName__c");
var patientDOB = X(doc, "X_ZPAPER__Birthdate__c");
var patientName = X(doc, "X_ZPAPER__Patient__r.Name");
var docType = X(doc, "X_ZPAPER__faxType__c");
//MSH181004 var zType = doc.X("X_docType");
var zType = X(doc, "X_docType");
//MSH180924 unused var nowDate = getCurDate(doc);
var caseRecordType = X(doc, "X_Case_Record_Type__c");
//MSH180924 unused var docTypeLabel = X(doc, "X_ZPAPER__faxTypeLabel");
var userClassification = X(doc, "X_ZPAPER__Classification__c");

//MSH180924 let's check the value before we try to use it; moved here from below
if (parentSfStackId === "") { //ERS170731 #40593
    alert("@@@@@@ parentSfStackId is empty. Attempting X_attachedTo");
    //MSH180924 does nothing; perhaps this? X(doc, "X_attachedTo");
    parentSfStackId = X(doc, "X_attachedTo");
    if (parentSfStackId.lastIndexOf("/") >= 0) {
        parentSfStackId = parentSfStackId.substring(parentSfStackId.lastIndexOf("/") + 1);
        if (parentSfStackId.indexOf(",") >= 0) {
            parentSfStackId = parentSfStackId.substring(0, parentSfStackId.indexOf(","));
        }
    }
}
alert("@@@@@@ parentSfStackId = " + parentSfStackId);
//alert("@@@@ parent stack id = " + sfStackId);
var parentStackNumber = getSFField(doc, "ZPAPER__zStack__c", "Name", null, parentSfStackId);
alert("#### Our parent stack number is " + parentStackNumber);
var zParentRecord = getSFFields(doc, "ZPAPER__zStack__c", "Name,ZPAPER__latestFax__c,ZPAPER__Classification__c,ZPAPER__Priority__c", null, parentSfStackId);
//MSH180924 unused var zStackClassification = X(doc, "ZPAPER__Classification__c", zParentRecord);
alert("@@@@@@ zParentRecord  " + zParentRecord);

var sfUserId = getSFRecordID(doc, "User", {"Username": doc.sfUserName});

//var zStackName = X(doc, "Name", zParentRecord);
var receivedAt = X(doc, "ZPAPER__latestFax__c", zParentRecord);

// Get the document type (will be used to route to next folder)
var nextFolder = "20500Triage-S2"; // Other folder is the default
var prevIndexPages = X(doc, "X_indexedPages");
var curIndexPages = X(doc, "X_idxPages");
if (prevIndexPages && prevIndexPages.length > 0 && curIndexPages && curIndexPages.length > 0) {
    prevIndexPages += ",";
}
curIndexPages = prevIndexPages + curIndexPages;
var arrOfPairs = [];
arrOfPairs.push("X_indexedPages", curIndexPages);
if (1 === 1) { //ERS170909 #40592 for zDocSet statuses
    //MSH180924 use X(doc, "nnnnnnn") instead var ba = doc.X("X_buttonAction")+"ed";
    /* MSH180924 moved to function above
     var ba = X(doc, "X_buttonAction") + "ed";
     ba = ba.substring(1 + ba.lastIndexOf(" "));
     var now0 = getCurDateAndTime(doc, false, true);
     arrOfPairs.push("X_reviewedStatus", ba);
     arrOfPairs.push("X_reviews", X(doc, "X_reviews") + ba + " by " + doc.kbData.remoteUser + " at " + now0 + "<br/>"); //ERS170909 #40592
     arrOfPairs.push("X_buttonAction", "");
     */
    setDocSetStatus(doc, arrOfPairs);
}
updateDB(doc, arrOfPairs);

var attachPath = X(doc, "X_attachedTo");
alert("@@@@@@ Currently attached to ZPAPER__zStack__c with ID: " + parentSfStackId);

/* SPLIT OFF NEW SNIPPET HERE */
var orgDocId = doc.dbID;
var response = splitDocumentForIndex(doc, "index", pageRange);
alert("splitDocumentForIndex response = " + response);
alert("Case '" + caseId + "' and len = " + caseId.length);

var childDocId = doc.dbID
alert("childDocId = " + childDocId);

//*
/* AFTER THIS POINT, THE DOC WILL HOLD DATA FOR NEW SNIPPET, NOT THE STACK SNIPPET */
//*

/*
 1. update original zStack
 2. ? unlockDocument
 3. ? moveDocument
 4. track
 5. createAndAttach child stack
 6. updateDB
 7. ? moveDocument
 */

/* 1. update original zStack */
//MSH181003 this should be done in Stack Complete, not here
//arrOfPairs = [];
var zp = "ZPAPER__"; //ERS170626 now in the package
var zStack = zp + "zStack__c"; //"Stack__c"
//arrOfPairs.push(zp + "Status__c", "Completed");
//updateSFRecord(doc, "ZPAPER__zStack__c", sfStackId, arrOfPairs);

/*
 2. ? unlockDocument
 3. ? moveDocument
 */
unlockDocument(doc);
moveDocument(doc, null, parentFolder);


/* 4. track */
var pageCount = zData.countPages(doc, pageRange);
track(doc, "Doc Indexed ", "Document with Id: " + doc.dbID, pageCount);
addPostExecutionScript(doc, "nextPage(~ready~);updateDEStatus(~indexed:" + pageRange + "~);");


/* 5. createAndAttach child stack */
arrOfPairs = [];
arrOfPairs.push(zp + "faxType__c", zType);
arrOfPairs.push(zp + "Priority__c", "Medium");
arrOfPairs.push(zp + "Status__c", "New Stack");
arrOfPairs.push(zp + "Channel__c", "Fax");
arrOfPairs.push(zp + "latestFax__c", formatNow);
arrOfPairs.push(zp + "receivedId__c", doc.dbID);
arrOfPairs.push(zp + "newFax__c", "true");
arrOfPairs.push(zp + "Pages__c", pageCount);
arrOfPairs.push("Group_ID__c", groupID);
arrOfPairs.push("Image_IDs__c", imagesForThisStack);
arrOfPairs.push("ZPAPER_zNativeFileName__c", nativeFileName);
if (zData.ownerId) {
    arrOfPairs.push("OwnerId", zData.ownerId);
}
if (zData.programName) {
    arrOfPairs.push(zp + "Program_Name__c", zData.programName);
}
arrOfPairs.push(zp + "sentFaxTo__c", doc.deliveredTo); //ERS170628 caller id
arrOfPairs.push(zp + "From__c", doc.deliveredFrom);
arrOfPairs.push(zp + "Stage__c", "Received"); //ERS170731 #40593
if (zData.programId) {
    arrOfPairs.push("ZPAPER_Program__c", zData.programId);
}
if (zData.classification) {
    arrOfPairs.push(zp + "Classification__c", zData.classification);
}
arrOfPairs.push("ZPAPER__Parent__c", parentSfStackId);

var childStackSFId = createAndAttach(doc, zStack, "zStack split on " + formatNow, arrOfPairs) + "";
alert("#### Stack Received. Attached to: " + childStackSFId);
var childStackNumber = getSFField(doc, zStack, "Name", null, childStackSFId);
//building attachment name PatientName+"-Stack#"+zStackName+"-"+docType+"-"+formatNow
var attachmentName = "";
if (patientName) {
    attachmentName += patientName + "-";
} else {
    attachmentName += patientFirstName + " " + patientLastName + "-";
}
attachmentName += "Stack#" + childStackNumber.replace(/^0+/, "") + "-" + docType + "-" + formatNow;

/* Attach the split document to a new Case record, if it wasn't passed in */
var priority = X(doc, "X_ZPAPER__Priority__c"); //ERS170626
//MSH180924 unused var label0="";
//MSH180924 unused var triageType=doc.docType;

/* Attach the split document to Contact record if required */
alert("@@@@ attaching to a Contact? contactId = " + contactId);
if (contactId && contactId.length > 0) {
    if (docType && docType.length > 0 && "POA" === docType) {
        attach(doc, attachmentName, contactId);
        if (attachPath.indexOf(contactId) == -1) {
            attachPath += "," + contactId;
        }
        tiffSfId = contactId;
    }
    var contactFlds = getSFFields(doc, "Contact", "FirstName,LastName", null, contactId);
    patientFirstName = X(doc, "FirstName", contactFlds);
    patientLastName = X(doc, "LastName", contactFlds);
} else if (patientFirstName && patientFirstName.length > 0 && patientLastName && patientLastName.length > 0 && patientDOB && patientDOB.length > 0) {
    /* Create new contact */
    var ctcArrOfPairs = [];
    ctcArrOfPairs.push("FirstName", patientFirstName);
    ctcArrOfPairs.push("LastName", patientLastName);
    ctcArrOfPairs.push("Birthdate", patientDOB);
    ctcArrOfPairs.push("OwnerId", sfUserId);
    if (zData.programId) {
        ctcArrOfPairs.push("Programref__c", zData.programId);
    }
    /* attach document to contact if docTpye is POA */
    if (docType && docType.length > 0 && "POA" === docType) {
        contactId = createAndAttach(doc, "Contact", attachmentName, ctcArrOfPairs);
        if (attachPath.indexOf(contactId) == -1) {
            attachPath += "," + contactId;
        }
        tiffSfId = contactId;
    } else {
        /* else only create contact */
        contactId = createSFRecord(doc, "Contact", attachmentName, ctcArrOfPairs);
    }

    //alert("@@@@@@@ DOCS PARAMS : " + doc.toString());
    alert("@@@@@@@ NEW CONTACT PARAMS: " + ctcArrOfPairs);
    alert("@@@@@@@ NEW CONTACT CREATED WITH ID: " + contactId);
    if (contactId != "NEW") {
        // clear out the "New Patient" fields
        addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__FirstName__c" + dq + ").val(" + dq + "" + dq + "); ");
        addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__LastName__c" + dq + ").val(" + dq + "" + dq + "); ");
        addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Birthdate__c" + dq + ").val(" + dq + "" + dq + "); ");
        addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Birthdate__c_readable" + dq + ").val(" + dq + "NONE" + dq + "); ");
        // set the Patient lookup fields
        addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Patient__c" + dq + ").val(" + dq + contactId + dq + "); ");
        addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Patient__c_Name" + dq + ").val(" + dq + patientFirstName + " " + patientLastName + dq + "); ");
    }
}
alert("userClassification = " + userClassification);
alert("zData.skipCaseTypeId = " + zData.skipCaseTypeId);
//alert("zData.skipCaseTypeId" + zData.skipCaseTypeId.indexOf(caseRecordType));

//lets create new case if caseId is empty
if (((!caseId || 0 === caseId.length) && "POA" != docType) && !(userClassification == "Cosentyx" && zData.skipCaseTypeId && zData.skipCaseTypeId.indexOf(caseRecordType) >= 0)) {
    alert("@@@@ creating new Case");
    arrOfPairs = [];
    //ERS170520 arrOfPairs.push("OwnerId", queuesMapKludge[X(doc, "X_Assign_to_Queue__c")]);
    arrOfPairs.push("ContactId", contactId);
    arrOfPairs.push("ZPAPER__newFax__c", "true"); //JPB 170512 added these workflow fields
    arrOfPairs.push("Received_Date__c", receivedAt);  //JPB 170512 added these workflow fields
    arrOfPairs.push("ZPAPER__receivedId__c", doc.dbID); //JPB 170512 added these workflow fields
    arrOfPairs.push("Status", X(doc, "X_Status"));
    arrOfPairs.push("OwnerId", sfUserId);
    arrOfPairs.push("RecordTypeId", caseRecordType);
    if (zData.programId) {
        arrOfPairs.push("Program__c", zData.programId);
    }
    arrOfPairs.push("Source__c", zData.sourceName);
    //MSH180408 arrOfPairs.push("Primary_Product__c", zData.productId);
    if (zData.productId) {
        arrOfPairs.push("Primary_Product__c", zData.productId);
    }
    //arrOfPairs.push("Type", "New Fax"); //JPB 170512 added these workflow fields//KPS 171109 commented out per Case#43497
    if (1 == 1) { //ERS170523 #37162 after dryrun
        //arrOfPairs.push("RecordTypeId","012Q00000005Ahj"); //ERS170523 Prior Auth
        if (priority != "Normal") {
            arrOfPairs.push("Priority", priority);  //ERS170524 #37162 priority on Case
        } else {
            arrOfPairs.push("Priority", "Medium");
        }
        arrOfPairs.push("Origin", "Fax");
    }
    alert("arrOfPairs Case ************: " + arrOfPairs);
    //var caseId = createAndAttach(doc, "Case", attachmentName, arrOfPairs);
    if (!docType || (docType && docType.length > 0 && "POA" != docType)) {
        caseId = createAndAttach(doc, "Case", attachmentName, arrOfPairs);
        if (attachPath.indexOf(caseId) == -1) {
            attachPath += "," + caseId;
        }
        tiffSfId = caseId;
    } else {
        caseId = createSFRecord(doc, "Case", attachmentName, arrOfPairs);
    }
    //if case get created successfully then let's update lookup field in triage form
    if (caseId != "NEW") {
        var caseFlds = getSFFields(doc, "Case", "CaseNumber", null, caseId);
        var caseNumber = X(doc, "CaseNumber", caseFlds);
        //lets update case lookup details here
        addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Case__c" + dq + ").val(" + dq + caseId + dq + "); ");
        addPostExecutionScript(doc, " $(" + dq + "#ZPAPER__Case__c_CaseNumber" + dq + ").val(" + dq + caseNumber + dq + "); ");
        //Case redirection here
        //MSH180408 Case record, not Patient record
        addPostExecutionScript(doc, ";if(confirm('View newly-created Case Record')){ location.href='" + doc.sfServer + "/apex/IntakePage?id=" + caseId + "'}");
    }
    alert("Created Case with ID: " + caseId);
    if (caseId == "null" || caseId == "NEW") {
        caseId = null; //ERS170621 TODO need a standard
    }
} else {
    //attach document to existing case if docType not equals POA
    if (docType && docType.length > 0 && "POA" != docType) {
        alert("@@@@ attaching to existing Case: " + caseId);
        attach(doc, attachmentName, caseId);
        if (attachPath.indexOf(caseId) == -1) {
            attachPath += "," + caseId;
        }
        tiffSfId = caseId;
    }
}

// lets create tiff image for pdf here
alert("### tiff flag ### = " + zData.generateTiff);
alert("### pageRange ### = " + pageRange);
attach(doc, attachmentName, parentSfStackId);
if (zData.generateTiff) {
    setDocumentContext(doc, orgDocId);
    /* MSH180130 #44986 create and attach tif */
    /* Attach file in addition to envelope */
    var nowTimeStamp = new Date().getTime() + "";
    //found in /zpdata/conf/workflow.props
    //a directory in which to do the work
    //integrationDir=/zpdata/agents/mck/integration/
    createDirectory(doc, zData.uploadDir, nowTimeStamp);
    //MSH181004 unused var stackName = getSFField(doc, "ZPAPER__zStack__c", "Name", "", sfStackId);
    //MSH180924 unused var fileName = getCurDate(doc) + " Stack " + stackName + " New "+zData.programName+" Fax.pdf";

    //Page Range can contain non-numeric characters from Page Rotation eg:### pageRange ###1u,2,8,7,6,5,4,3
    //make sure page range array is cleared of all non-numeric chars
    //MSH180924 don't need min & max, just strip out alpha chars.
    //      parsing is handled downstream in com.knowledgebin.Utils public static Collection<Integer> parsePages(String pages)
    //var maxPage = Math.max.apply(Math, pageRange.split(','));
    //var minPage = Math.min.apply(Math, pageRange.split(','));
    //alert("### All min max ###" + minPage + "-" + maxPage);
    //alert("@@@@@ Calling split, pages = " + minPage + "-" + maxPage + ", nowTimeStamp = " + nowTimeStamp);

    //regex: find all alpha chars ([a-z]), globally (g), and case-insensitive (i)
    var noAlphaPages = pageRange.replace(/[a-z]/gi, "");
    alert("@@@@@ Calling split, pages = " + noAlphaPages + ", nowTimeStamp = " + nowTimeStamp);

    //MSH180924 #52440 var response = splitPDF(doc, minPage + "-" + maxPage, zData.uploadDir, nowTimeStamp, doc.dbID);
    var response = splitPDF(doc, noAlphaPages, zData.uploadDir, nowTimeStamp, doc.dbID);
    alert("@@@@ response from splitPDF = " + response);
    var newPDFName = X(doc, "newPDF", response);
    alert("@@@@ split PDF FileName = " + newPDFName);
    var newTIFFName = pdf2tiff(doc, newPDFName);
    alert("@@@@ pdf2tiff FileName = " + newTIFFName);
    var label = attachmentName + ".tif";
    if (newTIFFName.indexOf("ERROR") !== 0) {
        var uploadURL = "http://localhost:8080/myfileforce/uploadToCloud.jsp?SFid=NEW&SFpid=" + tiffSfId + "&SForg=" + doc.sfOrg + "&label=" + label + "&serverFile=" + newTIFFName + "&Description=File attached by zPaper.";
        alert("#### Upload native PDF with " + uploadURL);
        var r = wget(doc, uploadURL);
        alert("#### tiff created and attached to: " + caseId);
        cleanupDirectory(doc, zData.uploadDir, nowTimeStamp);
        /* Finally, delete the work folder and all contents. */
        //MSH170222 ERS wants to keep cleanupDirectory(doc, "integrationDir", nowTimeStamp);
    }
    //MSH181008 since we changed the doc context, change it back
    setDocumentContext(doc, childDocId);
}

//lets update zStack record with patient and case details
arrOfPairs = [];
if (providerId && providerId.length > 0) {
    arrOfPairs.push("ZPAPER__Provider__c", providerId);
    if (attachPath.indexOf(providerId) == -1) {
        attachPath += "," + providerId;
    }
}
if (contactId && contactId.length > 0) {
    arrOfPairs.push("ZPAPER__Patient__c", contactId);
    if (attachPath.indexOf(contactId) == -1) {
        attachPath += "," + contactId;
    }
}
if (caseId && caseId.length > 0) {
    arrOfPairs.push("ZPAPER__Case__c", caseId);
}
if (patientFirstName && patientFirstName.length > 0) {
    arrOfPairs.push("ZPAPER__FirstName__c", patientFirstName);
}
if (patientLastName && patientLastName.length > 0) {
    arrOfPairs.push("ZPAPER__LastName__c", patientLastName);
}
if (patientDOB && patientDOB.length > 0) {
    arrOfPairs.push("ZPAPER__Birthdate__c", patientDOB);
}
if (docType && docType.length > 0) {
    arrOfPairs.push("ZPAPER__faxType__c", docType);
}
//MSH180924 #52440 populate groupID, imageIds, and zNativeFileName on child stack
if (groupID) {
    arrOfPairs.push("Group_ID__c", groupID);
}
if (nativeFileName) {
    arrOfPairs.push("ZPAPER_zNativeFileName__c", nativeFileName);
}
if (imagesForThisStack) {
    arrOfPairs.push("Image_IDs__c", imagesForThisStack);
}
//MSH180924 #52440 END

alert("@@@@ Before update stack record arrOfPairs === " + arrOfPairs);
alert("@@@@ update stack record childStackSFId === " + childStackSFId);
updateSFRecord(doc, "ZPAPER__zStack__c", childStackSFId, arrOfPairs);
//attach(doc, attachmentName, sfStackId);
//alert("@@@@ updated zStack Record, id = " + childStackSFId);

if (1 === 0) { //ERS170627 TODO refactor
    //CRN170208 If we have a Contact and the user sent a Provider, add the provider to the Contact.
    var provider = X(doc, "X_Primary_Care_Physician__c");
    if (contactId && contactId.length > 0 && provider && provider.length > 0) {
        arrOfPairs = [];
        arrOfPairs.push("Primary_Care_Physician__c", provider);
        updateSFRecord(doc, "Contact", contactId, arrOfPairs);
    }
}

/* Move the split document to its processing folder */
alert("@@@@@@ Moving the indexed pages document into next processing folder: " + nextFolder);
//moveDocument(doc,"",nextFolder);
//reloadByBATES(doc, nextFolder); //ERS170413 #35291
/* Place the split document into the stack folder */
alert("@@@@@@ Moving the indexed pages document into the final stack folder: " + stackFolder);
//moveDocument(doc,"",stackFolder);
parentFolder = doc.kbData.groupID.substring(1) + "In";
moveDocument(doc, doc.userID + "In", parentFolder);
unlockDocument(doc);


/* 6. updateDB */

arrOfPairs = [];
//MSH181008 debugging
alert("@@@@ child doc.dbID = " + doc.dbID);
alert("@@@@ parent doc.dbID = " + parentdbID);
//ERS170909 arrOfPairs.push("X_reviewedStatus", "Indexed");
if (1 === 1) { //ERS170909 #40592 for zDocSet statuses
    //MSH180924 use X(doc, "nnnnnnn") instead var ba = doc.X("X_buttonAction")+"ed";
    /* MSH180924 moved to function above
     var ba = X(doc, "X_buttonAction") + "ed";
     ba = ba.substring(1 + ba.lastIndexOf(" "));
     var now0 = getCurDateAndTime(doc, false, true);
     arrOfPairs.push("X_reviewedStatus", ba);
     arrOfPairs.push("X_reviews", X(doc, "X_reviews") + ba + " by " + doc.kbData.remoteUser + " at " + now0 + "<br/>"); //ERS170909 #40592
     arrOfPairs.push("X_buttonAction", "");
     */
    setDocSetStatus(doc, arrOfPairs);
}
/* CRN160825 Set the page count so that it does not have the parent page count */
pageCount = zData.countPages(doc, pageRange);
alert("@@@@ pageCount = " + pageCount);
arrOfPairs.push("X_pages", pageCount);
arrOfPairs.push("db-pages", pageCount);
arrOfPairs.push("db-label", patientFirstName + patientLastName + " - " + companyCode + " - " + childStackSFId);
arrOfPairs.push("db-BATES", childStackSFId + "-STACK");
arrOfPairs.push("X_sfStackId", childStackSFId);
//CRN180618 Make sure that the latest attachment is first in the list because files.jspf uses that first one to pull pre-pop data.
attachPath = X(doc, "X_attachedTo");
var attachIds = attachPath.substring(attachPath.lastIndexOf("/") + 1);
attachIds = attachIds.split(",");
var buffer = childStackSFId + "";
for (var idx in attachIds) {
    if (attachIds.hasOwnProperty(idx)) {
        var attachId = attachIds[idx];
        if (attachId !== childStackSFId) {
            buffer += "," + attachId;
        }
    }
}
attachPath = attachPath.substring(0, attachPath.lastIndexOf("/") + 1) + buffer;
alert("@@@ new X_attachedTo = " + attachPath);
arrOfPairs.push("X_attachedTo", attachPath);

if (!patientFirstName || 0 == patientFirstName.length) {
    patientFirstName = "Unknown";
}
if (!patientLastName || 0 == patientLastName.length) {
    patientLastName = "Name";
}
arrOfPairs.push("db-label", patientFirstName + patientLastName + " - " + companyCode + " - " + childStackSFId);
updateDB(doc, arrOfPairs);

track(doc, "Doc Indexed ", "Document with Id: " + doc.dbID, pageCount);
addPostExecutionScript(doc, "nextPage(~ready~);updateDEStatus(~indexed:" + pageRange + "~);");
/* END Index Page */

//--- RULE CONSEQUENCE CODE - END ---

//--- RULE VALIDATION CODE ---
ZnVuY3Rpb24gekluc3RhbGwoKSB7IC8vRVJTMTcwNzIyIHNldCBvbiB0aGUgaW1wb3J0CiAgICAkKCJbbmFtZT0nZGItQkFURVMnXSIpLnZhbCgiIik7CiAgICAkKCIjWF9idXR0b25BY3Rpb25zIikudmFsKCJJbmRleCxJZ25vcmUsUmVqZWN0LFN0YWNrIENvbXBsZXRlIik7CiAgICAkKCIjWF9mb2xkZXJGb3JtcyIpLnZhbCgiMjAyMDAyMDE3MTEyNTA5MTExNV9EYXRhMl9XZWJfRm9ybSIpOwp9IC8vRVJTMTcwNzIyIGVuZCBvZiBmdW5jdGlvbgoKZnVuY3Rpb24gZG9WYWxpZGF0aW9uKCkgewogICAgLy9DUk4xNzA3MTkgRHJ1ZyBuYW1lIGlzIHJlcXVpcmVkCiAgICAvL0VSUzE3MDcxOSBtb3JlIGZpZWxkcyBmcm9tIEtlbgogICAgdmFyIGNhc2VJZCA9ICQoJ1tuYW1lPSJYX0Nhc2VfX2MiXScpLnZhbCgpOwogICAgCiAgICAKICAgIHZhciByZXFCdWZmZXIgPSAiIjsKICAgIHZhciBwYXR0ZXJuU3RyaW5nID0gL15bYS16QS1aIF0rJC87CiAgICBuPSJYX1pQQVBFUl9fZmF4VHlwZV9fYyI7IGw9IkRvY3VtZW50IFR5cGUiOwogICAgZT0kKCdbbmFtZT0iJytuKyciXScpOwogICAgdmFyIGRvY1R5cGUgPSBlLnZhbCgpOwogICAvLyBfekRhdGEuZG9jVHlwZUxhYmVsID0gJChlKS5maW5kKCJvcHRpb246c2VsZWN0ZWQiKS50ZXh0KCk7CiAgICAvL2FsZXJ0KCBfekRhdGEuZG9jVHlwZUxhYmVsKTsKICAgCi8vdmFsaWRhdGUgZG9jVHlwZSBoZXJlCiAgICBpZiAoIWUudmFsKCkgfHwgMCA9PT0gZS52YWwoKS5sZW5ndGggfHwgIkRPTk9UX1NBVkUiID09PSBlLnZhbCgpKSB7CiAgICAgICAgZS5jc3MoJ2JvcmRlcicsJzNweCBzb2xpZCByZWQnKTsKICAgICAgICBpZiAocmVxQnVmZmVyLmxlbmd0aCA+IDApIHsgcmVxQnVmZmVyICs9ICIsICI7IH0KICAgICAgICByZXFCdWZmZXIgKz0gbDsKICAgIH0gZWxzZXsKICAgICAgICBlLmNzcygnYm9yZGVyJywnM3B4IHNvbGlkIGdyZWVuJyk7CiAgICAgICAgdmFyIGRvY1R5cGVMYWJlbD0gJChlKS5maW5kKCJvcHRpb246c2VsZWN0ZWQiKS50ZXh0KCk7CiAgICAgICAgdmFyIGRvY1R5cGVMYWJlbERvbSA9ICQoJ1tuYW1lPSJYX1pQQVBFUl9fZmF4VHlwZUxhYmVsIl0nKTsKICAgICAgICAKICAgICAgICBpZighZG9jVHlwZUxhYmVsRG9tLnZhbCgpIHx8IDAgPT09IGRvY1R5cGVMYWJlbERvbS52YWwoKS5sZW5ndGgpewogICAgICAgICAgIAogICAgICAgICAgICAkKCdmb3JtI2RhdGFFbnRyeUZvcm0nKS5hcHBlbmQoJzxpbnB1dCB0eXBlPSJoaWRkZW4iIG5hbWU9IlhfWlBBUEVSX19mYXhUeXBlTGFiZWwiIGlkPSJYX1pQQVBFUl9fZmF4VHlwZUxhYmVsIiB2YWx1ZT0iJytkb2NUeXBlTGFiZWwrJyIvPicpOwoKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgCiAgICAgICAgICAgICQoZG9jVHlwZUxhYmVsRG9tKS52YWwoZG9jVHlwZUxhYmVsKTsKICAgICAgICB9CiAgICAgICAgCiAgICB9IAogICAgCiAgCiAgICAvL3ZhbGlkYXRlIHBhdGllbnQgaGVyZSAsaWYgcGF0aWVudElkIGlzIGVtcHR5ICB0aGVuIGZpcnN0TmFtZSxsYXN0TmFtZSxCaXJ0aERhdGUgbWFuZGF0b3J5IGFuZCBmaXJzdE5hbWUgYW5kIGxhc3ROYW1lIHNob3VsZCBiZSBzdHJpbmcKICAgIHZhciBwYXRpZW50SWQ9JCgnW25hbWU9IlhfWlBBUEVSX19QYXRpZW50X19yLk5hbWUiXScpLnZhbCgpOwogICAgaWYoIXBhdGllbnRJZCB8fCAwID09PSBwYXRpZW50SWQubGVuZ3RoKXsKICAgICAgICB2YXIgcGFpdGVudERlID0gJCgnW25hbWU9IlhfWlBBUEVSX19GaXJzdE5hbWVfX2MiXScpOwogICAgICAgIAogICAgICAgICBpZighcGFpdGVudERlLnZhbCgpIHx8IDAgPT09IHBhaXRlbnREZS52YWwoKS5sZW5ndGgpewogICAgICAgICAgICBwYWl0ZW50RGUuY3NzKCdib3JkZXInLCczcHggc29saWQgcmVkJyk7CiAgICAgICAgICAgIHJlcUJ1ZmZlciArPSAiLEZpcnN0TmFtZSI7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIGlmKCEocGFpdGVudERlLnZhbCgpLm1hdGNoKHBhdHRlcm5TdHJpbmcpKSl7CiAgICAgICAgICAgICAgICAgYWxlcnQoIkVSUk9SOiAgJ0ZpcnN0TmFtZScgTXVzdCBiZSBTdHJpbmcuIik7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICBwYWl0ZW50RGUuY3NzKCdib3JkZXInLCczcHggc29saWQgZ3JlZW4nKTsgCiAgICAgICAgfSAKCiAgICAgICAgIHBhaXRlbnREZSAgPSAkKCdbbmFtZT0iWF9aUEFQRVJfX0xhc3ROYW1lX19jIl0nKTsKICAgICAgICAgaWYoIXBhaXRlbnREZS52YWwoKSB8fCAwID09PSBwYWl0ZW50RGUudmFsKCkubGVuZ3RoKXsKICAgICAgICAgICAgcGFpdGVudERlLmNzcygnYm9yZGVyJywnM3B4IHNvbGlkIHJlZCcpOwogICAgICAgICAgICByZXFCdWZmZXIgKz0gIixMYXN0TmFtZSI7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIGlmKCEocGFpdGVudERlLnZhbCgpLm1hdGNoKHBhdHRlcm5TdHJpbmcpKSl7CiAgICAgICAgICAgICAgICBhbGVydCgiRVJST1I6ICAnTGFzdE5hbWUnIE11c3QgYmUgU3RyaW5nLiIpOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBhaXRlbnREZS5jc3MoJ2JvcmRlcicsJzNweCBzb2xpZCBncmVlbicpOwogICAgICAgIH0gCgogICAgICAgIHBhaXRlbnREZSA9ICQoJ1tuYW1lPSJYX1pQQVBFUl9fQmlydGhkYXRlX19jIl0nKTsKICAgICAgICAgaWYoIXBhaXRlbnREZS52YWwoKSB8fCAwID09PSBwYWl0ZW50RGUudmFsKCkubGVuZ3RoKXsKICAgICAgICAgICAgcGFpdGVudERlLmNzcygnYm9yZGVyJywnM3B4IHNvbGlkIHJlZCcpOwogICAgICAgICAgICQoIiNaUEFQRVJfX0JpcnRoZGF0ZV9fY19yZWFkYWJsZSIpLmNzcygnYm9yZGVyJywnM3B4IHNvbGlkIHJlZCcpOyAKICAgICAgICAgICAgcmVxQnVmZmVyICs9ICIsQmlydGhkYXRlIjsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgcGFpdGVudERlLmNzcygnYm9yZGVyJywnM3B4IHNvbGlkIGdyZWVuJyk7CiAgICAgICAgICAgICQoIiNaUEFQRVJfX0JpcnRoZGF0ZV9fY19yZWFkYWJsZSIpLmNzcygnYm9yZGVyJywnM3B4IHNvbGlkIGdyZWVuJyk7CiAgICAgICAgfSAKCgogICAgfQovL3ZsYWlkYXRlIGNhc2VJZCAsaWYgY2FzZUlkIGlzIGVtcHR5IHRoZW4gbWFrZSBjYXNlUmVjb3JkVHlwZSBpcyBtYW5kYXRvcnkgCiAgICBjYXNlSWQ9JCgnW25hbWU9IlhfWlBBUEVSX19DYXNlX19yLkNhc2VOdW1iZXIiXScpLnZhbCgpOwogICAgaWYoIWNhc2VJZCB8fCAwID09PSBjYXNlSWQubGVuZ3RoKXsKICAgICAgICB2YXIgY2FzZVJlY29yZFR5cGUgPSAkKCdbbmFtZT0iWF9DYXNlX1JlY29yZF9UeXBlX19jIl0nKTsgLy9LUFMxNzEwMjMgYWRkaW5nIHJlY29yZCB0eXBlIHZhbGlkYXRpb24KICAgICAgICAKICAgIGlmKCJQT0EiICE9IGRvY1R5cGUgJiYgKCFjYXNlUmVjb3JkVHlwZS52YWwoKSB8fCAwID09PSBjYXNlUmVjb3JkVHlwZS52YWwoKS5sZW5ndGggfHwgIkRPTk9UX1NBVkUiID09PSBjYXNlUmVjb3JkVHlwZS52YWwoKSkpewogICAgICAgICAgICBjYXNlUmVjb3JkVHlwZS5jc3MoJ2JvcmRlcicsJzNweCBzb2xpZCByZWQnKTsKICAgICAgICAgICAgcmVxQnVmZmVyICs9ICIsQ2FzZSBSZWNvcmQgVHlwZSI7CiAgICAgICAgfWVsc2UgY2FzZVJlY29yZFR5cGUuY3NzKCdib3JkZXInLCczcHggc29saWQgZ3JlZW4nKTsKCiAgICB9CgogICAgdmFyIHBhdHRlcm5OdW0gPSAvXlswLTldKyQvOwogICAgLy92YWxpZGF0ZSBOUEksIGlmIE5QSSBub3QgZW1wdHkgdGhlbiBpdCBzaG91bGQgYmUgMTAgZGlnaXQgbnVtYXJpYwogICAgdmFyIG5waT0kKCdbbmFtZT0iWF9aUEFQRVJfX05QSV9fYyJdJyk7CiAgICAgICAgaWYgKG5waS52YWwoKSAmJiAobnBpLnZhbCgpLmxlbmd0aCAhPTEwIHx8ICFucGkudmFsKCkubWF0Y2gocGF0dGVybk51bSkpKSB7CiAgICAgICAgICAgIG5waS5jc3MoJ2JvcmRlcicsJzNweCBzb2xpZCByZWQnKTsKICAgICAgICAgICAgaWYgKHJlcUJ1ZmZlci5sZW5ndGggPiAwKSB7IHJlcUJ1ZmZlciArPSAiLCAiOyB9CiAgICAgICAgICAgIHJlcUJ1ZmZlciArPSAiTlBJIjsKICAgICAgICAgICAgYWxlcnQoIkVSUk9SOiAgJ05QSScgTXVzdCBiZSAxMCBkaWdpdCBudW1hcmljLiIpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfWVsc2UgbnBpLmNzcygnYm9yZGVyJywnM3B4IHNvbGlkIGdyZWVuJyk7CiAgICAvLyBub3RpZnkgdmFsaWRhdGlvbiBlcnJvcnMgaWYgYW55CiAgICBpZiAocmVxQnVmZmVyLmxlbmd0aCA+IDApIHsKICAgICAgICBhbGVydCgiRVJST1I6IFRoZSBmb2xsb3dpbmcgZmllbGRzIGFyZSByZXF1aXJlZDogIiArIHJlcUJ1ZmZlcik7CiAgICAgICAgcmV0dXJuIGZhbHNlOyAgIC8vQ1JOMTcwNzE5IG9uZSBvciBtb3JlIGZpZWxkIGlzIG1pc3NpbmcsIGRvbid0IHNlbmQgdG8gdGhlIHJ1bGVzIGVuZ2luZQogICAgfQogICAgcmV0dXJuIHRydWU7ICAgICAgICAvL0NSTjE3MDcxOSBBbGwgcmVxdWlyZWQgZmllbGRzIGhhdmUgYmVlbiBzdXBwbGllZCwgbGV0IHRoZSBydWxlcyBlbmdpbmUgYmUgbm90aWZpZWQKfQoKcmV0dXJuIGRvVmFsaWRhdGlvbigpOwo=
//--- RULE VALIDATION CODE - END ---

</script>
